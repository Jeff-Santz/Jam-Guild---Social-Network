<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Engine</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: system-ui, sans-serif; background: #0a0a0a; color: #e0e0e0; line-height: 1.5; }
        .container { max-width: 900px; margin: 0 auto; padding: 10px; }
        input, textarea, select, button { font-family: inherit; font-size: 14px; padding: 8px 12px; border: 1px solid #333; background: #1a1a1a; color: #e0e0e0; border-radius: 4px; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #4a9eff; }
        button { cursor: pointer; background: #2a2a2a; }
        button:hover { background: #3a3a3a; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #1d4ed8; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-danger { background: #b91c1c; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-success { background: #15803d; color: white; }
        .btn-success:hover { background: #16a34a; }
        .btn-secondary { background: #444; color: white; }
        .btn-secondary:hover { background: #555; }
        .btn-pending { background: #6b7280; color: white; cursor: not-allowed; }
        .tabs { display: flex; gap: 5px; border-bottom: 1px solid #333; margin-bottom: 15px; padding-bottom: 10px; flex-wrap: wrap; }
        .tabs button { border: none; background: transparent; color: #888; padding: 8px 16px; }
        .tabs button.active { color: #4a9eff; border-bottom: 2px solid #4a9eff; }
        .card { background: #1a1a1a; border: 1px solid #333; border-radius: 6px; padding: 15px; margin-bottom: 12px; }
        .post-header { display: flex; justify-content: space-between; margin-bottom: 8px; flex-wrap: wrap; gap: 5px; }
        .post-author { font-weight: bold; color: #4a9eff; cursor: pointer; }
        .post-author:hover { text-decoration: underline; }
        .post-origin { font-size: 12px; color: #666; cursor: pointer; }
        .post-origin.clickable:hover { color: #4a9eff; text-decoration: underline; }
        .post-content { margin: 10px 0; white-space: pre-wrap; word-break: break-word; }
        .post-media { max-width: 100%; max-height: 300px; border-radius: 4px; margin: 10px 0; }
        .post-actions { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .post-actions button { font-size: 12px; padding: 4px 10px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 4px; font-size: 13px; color: #888; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; }
        textarea { min-height: 80px; resize: vertical; }
        .auth-box { max-width: 400px; margin: 50px auto; }
        .auth-toggle { text-align: center; margin-top: 15px; }
        .auth-toggle a { color: #4a9eff; cursor: pointer; text-decoration: underline; }
        .error { color: #f87171; font-size: 13px; margin-top: 5px; }
        .success { color: #4ade80; font-size: 13px; margin-top: 5px; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #333; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .header h1 { font-size: 20px; color: #4a9eff; cursor: pointer; }
        .user-info { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .comments-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid #333; }
        .comment { background: #222; padding: 10px; border-radius: 4px; margin-bottom: 8px; border-left: 3px solid #333; }
        .comment.depth-1 { margin-left: 20px; border-left-color: #4a9eff; }
        .comment.depth-2 { margin-left: 40px; border-left-color: #15803d; }
        .comment.depth-3 { margin-left: 60px; border-left-color: #b91c1c; }
        .comment-header { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; }
        .comment-author { color: #4a9eff; font-weight: bold; cursor: pointer; }
        .comment-author:hover { text-decoration: underline; }
        .comment-actions { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
        .comment-actions button { font-size: 11px; padding: 2px 8px; }
        .reply-indicator { background: #333; padding: 5px 10px; border-radius: 4px; margin-bottom: 8px; font-size: 12px; display: flex; justify-content: space-between; }
        .community-card { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .community-info h3 { color: #4a9eff; margin-bottom: 4px; cursor: pointer; }
        .community-info h3:hover { text-decoration: underline; }
        .community-info p { font-size: 13px; color: #888; }
        .community-meta { font-size: 12px; color: #666; }
        .notification { padding: 10px; border-left: 3px solid #333; cursor: pointer; }
        .notification:hover { background: #252535; }
        .notification.unread { background: #1a2a3a; border-left-color: #4a9eff; }
        .notification.read { opacity: 0.6; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 20px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal h3 { margin-bottom: 15px; color: #4a9eff; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px; flex-wrap: wrap; }
        .loading { text-align: center; padding: 20px; color: #888; }
        .empty { text-align: center; padding: 30px; color: #666; }
        .likes-count { color: #f87171; }
        .liked { color: #f87171 !important; background: #3a1a1a !important; }
        .badge { display: inline-block; padding: 2px 6px; font-size: 10px; border-radius: 3px; background: #333; margin-left: 5px; }
        .badge.unread { background: #1d4ed8; }
        .back-btn { margin-bottom: 15px; }
        .profile-header { padding: 20px; border-bottom: 1px solid #333; margin-bottom: 15px; }
        .profile-header h2 { color: #4a9eff; margin-bottom: 5px; }
        .profile-stats { display: flex; gap: 20px; margin: 10px 0; font-size: 13px; color: #888; }
        .profile-bio { color: #aaa; font-size: 14px; margin: 10px 0; }
        .profile-actions { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .member-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #333; }
        .member-item:last-child { border-bottom: none; }
        .member-info { display: flex; align-items: center; gap: 10px; }
        .member-role { font-size: 11px; padding: 2px 6px; border-radius: 3px; background: #333; }
        .member-role.master { background: #b91c1c; }
        .member-role.admin { background: #1d4ed8; }
        .search-box { display: flex; gap: 10px; margin-bottom: 15px; }
        .search-box input { flex: 1; }
        .friend-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #222; border-radius: 4px; margin-bottom: 8px; }
        .sub-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .sub-tabs button { font-size: 12px; padding: 6px 12px; }
        .sub-tabs button.active { background: #1d4ed8; color: white; }
        .toast { position: fixed; bottom: 80px; right: 20px; background: #1d4ed8; color: white; padding: 12px 20px; border-radius: 6px; z-index: 2000; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .report-item { padding: 15px; border-left: 3px solid #b91c1c; margin-bottom: 10px; background: #1a1a1a; }
        .report-meta { font-size: 12px; color: #666; margin-top: 5px; }
        .checkbox-group { display: flex; align-items: center; gap: 8px; }
        .checkbox-group input[type="checkbox"] { width: auto; }
        
        /* STYLES */
        .cover-image { width: 100%; height: 150px; object-fit: cover; border-radius: 6px 6px 0 0; }
        .profile-avatar { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #4a9eff; object-fit: cover; margin-top: -40px; background: #1a1a1a; }
        .profile-avatar-small { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
        .lock-icon { color: #f87171; margin-left: 8px; }
        .char-counter { font-size: 12px; margin-left: 10px; }
        .char-counter.warning { color: #fbbf24; }
        .char-counter.danger { color: #f87171; }
        .danger-zone { border: 1px solid #b91c1c; border-radius: 6px; padding: 15px; margin-top: 20px; background: rgba(185, 28, 28, 0.1); }
        .danger-zone h4 { color: #f87171; margin-bottom: 10px; }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .file-input-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; }
        .image-preview { max-width: 100%; max-height: 150px; border-radius: 4px; margin-top: 10px; }
        .post-delete-btn { padding: 2px 6px !important; font-size: 11px !important; }
        .role-select { padding: 4px 8px; font-size: 12px; }
        .user-header-row { display: flex; align-items: center; gap: 10px; }
        .community-tag { display: inline-block; background: #7c3aed; color: white; font-size: 11px; padding: 2px 8px; border-radius: 4px; margin-bottom: 5px; cursor: pointer; }
        .community-tag:hover { background: #8b5cf6; }
    </style>
</head>
<body>
    <div id="app">
        <!-- Language Selector (Fixed Bottom Right) -->
        <div style="position: fixed; bottom: 10px; right: 10px; z-index: 1000;">
            <select v-model="currentLang" @change="changeLanguage" style="padding: 5px; font-size: 12px; background: #222; color: #fff; border: 1px solid #444; border-radius: 4px;">
                <option :value="1">PT-BR</option>
                <option :value="0">EN-US</option>
            </select>
        </div>

        <!-- Toast Notification -->
        <div v-if="toast.show" class="toast">{{ toast.message }}</div>

        <!-- AUTH SCREEN -->
        <div v-if="!isLoggedIn" class="auth-box">
            <div class="card">
                <h2 style="text-align:center; margin-bottom:20px;">{{ t('UI_TITLE_LOGIN') }}</h2>
                
                <!-- LOGIN FORM -->
                <div v-if="!isRegistering">
                    <div class="form-group">
                        <label>{{ t('UI_LBL_ID') }}</label>
                        <input v-model="loginForm.identifier" type="text" placeholder="Username or Email">
                    </div>
                    <div class="form-group">
                        <label>{{ t('UI_LBL_PASS') }}</label>
                        <input v-model="loginForm.password" type="password" @keyup.enter="login">
                    </div>
                    <button class="btn-primary" style="width:100%" @click="login" :disabled="loading">
                        {{ t('UI_BTN_LOGIN') }}
                    </button>
                </div>

                <!-- SIGNUP FORM -->
                <div v-else>
                    <div class="form-group">
                        <label>{{ t('UI_LBL_USERNAME') }}</label>
                        <input v-model="signupForm.username" type="text">
                    </div>
                    <div class="form-group">
                        <label>{{ t('UI_LBL_EMAIL') }}</label>
                        <input v-model="signupForm.email" type="email">
                    </div>
                    <div class="form-group">
                        <label>{{ t('UI_LBL_PASS') }}</label>
                        <input v-model="signupForm.password" type="password">
                    </div>
                    <div class="form-group">
                        <label>{{ t('UI_LBL_STATE') }}</label>
                        <select v-model="signupForm.state" @change="loadCities(signupForm.state)">
                            <option value="" disabled>{{ t('UI_SELECT') }}...</option>
                            <option v-for="uf in serverStates" :key="uf" :value="uf">{{ uf }}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>{{ t('UI_LBL_CITY') }}</label>
                        <select v-model="signupForm.city" :disabled="!signupForm.state">
                            <option value="" disabled>{{ t('UI_SELECT') }}...</option>
                            <option v-for="city in serverCities" :key="city" :value="city">{{ city }}</option>
                        </select>
                    </div>
                    <button class="btn-success" style="width:100%" @click="signup" :disabled="loading">
                        {{ t('UI_BTN_SIGNUP') }}
                    </button>
                </div>

                <p v-if="authError" class="error">{{ authError }}</p>
                <p v-if="authSuccess" class="success">{{ authSuccess }}</p>

                <div class="auth-toggle">
                    <span v-if="!isRegistering">
                        {{ t('UI_BTN_SIGNUP') }}? <a @click="isRegistering = true; authError = ''">{{ t('UI_BTN_LOGIN_LINK') }}</a>
                    </span>
                    <span v-else>
                        {{ t('UI_BTN_LOGIN') }}? <a @click="isRegistering = false; authError = ''">{{ t('UI_BTN_REGISTER_LINK') }}</a>
                    </span>
                </div>
            </div>
        </div>

        <!-- MAIN APP -->
        <div v-else class="container">
            <div class="header">
                <h1 @click="goToFeed">Social Engine</h1>
                <div class="user-info">
                    <div class="user-header-row">
                        <img v-if="currentUser.avatar_url" :src="API_BASE + currentUser.avatar_url" class="profile-avatar-small" @error="$event.target.style.display='none'">
                        <span style="cursor:pointer;" @click="viewProfile(currentUser.id)">{{ currentUser.username }} (ID: {{ currentUser.id }})</span>
                    </div>
                    <button @click="logout">{{ t('UI_NAV_LOGOUT') }}</button>
                </div>
            </div>

            <!-- NAVIGATION TABS -->
            <div class="tabs">
                <button :class="{ active: currentView === 'feed' }" @click="goToFeed">
                    {{ t('TAB_FEED') }}
                </button>
                <button :class="{ active: currentView === 'communities' }" @click="currentView = 'communities'; loadCommunities()">
                    {{ t('TAB_COMMUNITIES') }}
                </button>
                <button :class="{ active: currentView === 'friends' }" @click="currentView = 'friends'; loadFriends()">
                    {{ t('TAB_FRIENDS') || 'Friends' }}
                </button>
                <button :class="{ active: currentView === 'notifications' }" @click="currentView = 'notifications'; loadNotifications()">
                    {{ t('TAB_NOTIFICATIONS') }}
                    <span v-if="unreadCount > 0" class="badge unread">{{ unreadCount }}</span>
                </button>
                <button :class="{ active: currentView === 'profile' && viewedProfile && viewedProfile.id === currentUser.id }" @click="viewProfile(currentUser.id)">
                    {{ t('TAB_PROFILE') || 'My Profile' }}
                </button>
                <button v-if="currentUser.id === 1" :class="{ active: currentView === 'admin' }" @click="currentView = 'admin'; loadReports()">
                    Admin
                </button>
            </div>

            <!-- ==================== FEED VIEW ==================== -->
            <div v-if="currentView === 'feed'">
                <!-- CREATE POST -->
                <div class="card">
                    <div class="form-group">
                        <textarea v-model="newPost.content" :placeholder="t('UI_WRITE_PLACEHOLDER')" maxlength="300"></textarea>
                    </div>
                    <!-- Image Upload -->
                    <div v-if="newPost.imagePreview" style="margin-bottom:10px;">
                        <img :src="newPost.imagePreview" class="image-preview">
                        <button @click="clearPostImage" style="margin-left:10px; font-size:12px;">X {{ t('UI_BTN_REMOVE') || 'Remove' }}</button>
                    </div>
                    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                        <button class="btn-primary" @click="createPost" :disabled="!newPost.content.trim() || newPost.content.length > 300">
                            {{ t('UI_BTN_SEND') }}
                        </button>
                        <div class="file-input-wrapper">
                            <button class="btn-secondary">{{ t('UI_BTN_MEDIA') || 'Add Image' }}</button>
                            <input type="file" accept="image/*" @change="handlePostImage">
                        </div>
                        <span class="char-counter" :class="{ warning: newPost.content.length > 250, danger: newPost.content.length > 290 }">
                            {{ newPost.content.length }}/300
                        </span>
                    </div>
                </div>

                <!-- POSTS LIST -->
                <div v-if="loading" class="loading">{{ t('UI_LOADING') }}</div>
                <div v-else-if="posts.length === 0" class="empty">{{ t('UI_NO_POSTS') }}</div>
                <div v-else>
                    <div v-for="post in posts" :key="post.id" class="card">
                        <!-- Purple Community Tag -->
                        <div v-if="post.community_id > 0" class="community-tag" @click="viewCommunity(post.community_id)">
                            {{ post.origin || 'Community' }}
                        </div>
                        <div class="post-header">
                            <span class="post-author" @click="viewProfile(post.author_id)">{{ post.author }}</span>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <span v-if="!post.community_id || post.community_id <= 0" class="post-origin">
                                    {{ post.location || '' }}
                                </span>
                                <button v-if="post.author_id === currentUser.id || currentUser.id === 1" class="btn-danger post-delete-btn" @click="deletePost(post)">
                                    &#128465;
                                </button>
                            </div>
                        </div>
                        <div class="post-content">{{ post.content }}</div>
                        <img v-if="post.media_url" :src="API_BASE + post.media_url" class="post-media" @error="$event.target.style.display='none'">
                        <div class="post-actions">
                            <button @click="toggleLike(post)" :class="{ liked: post.liked_by_me }">
                                &#9829; <span class="likes-count">{{ post.likes }}</span> {{ t('UI_LBL_LIKES') }}
                            </button>
                            <button @click="toggleComments(post)">
                                {{ post.showComments ? t('UI_BTN_HIDE') || 'Hide' : t('UI_BTN_VIEW') || 'View' }} {{ post.comments_count || 0 }} {{ t('UI_BTN_COMMENTS') }}
                            </button>
                            <button class="btn-danger" @click="openReportModal('post', post.id)">
                                {{ t('UI_BTN_REPORT') }}
                            </button>
                        </div>

                        <!-- COMMENTS SECTION -->
                        <div v-if="post.showComments" class="comments-section">
                            <!-- Reply Indicator -->
                            <div v-if="post.replyingTo" class="reply-indicator">
                                <span>{{ t('UI_LBL_REPLYING_TO') }}: {{ post.replyingTo.author_name }}</span>
                                <button @click="cancelReply(post)">{{ t('UI_BTN_CANCEL_REPLY') }}</button>
                            </div>

                            <!-- New Comment Form -->
                            <div class="form-group">
                                <textarea v-model="post.newComment" 
                                    :placeholder="post.replyingTo ? t('UI_PLACEHOLDER_REPLY') : t('UI_PLACEHOLDER_COMMENT')"
                                    style="min-height:50px;" maxlength="200"></textarea>
                            </div>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <button class="btn-primary" @click="submitComment(post)" :disabled="!post.newComment || !post.newComment.trim() || post.newComment.length > 200">
                                    {{ t('UI_BTN_COMMENT_ACTION') }}
                                </button>
                                <span class="char-counter" :class="{ warning: (post.newComment || '').length > 160, danger: (post.newComment || '').length > 190 }">
                                    {{ (post.newComment || '').length }}/200
                                </span>
                            </div>

                            <!-- Comments Tree (Recursive Rendering) -->
                            <div v-if="post.comments && post.comments.length > 0" style="margin-top:15px;">
                                <template v-for="comment in buildCommentTree(post.comments)" :key="comment.id">
                                    <comment-item 
                                        :comment="comment" 
                                        :post="post" 
                                        :current-user="currentUser"
                                        :depth="0"
                                        :t="t"
                                        @reply="setReplyTo(post, $event)"
                                        @like="toggleCommentLike(post, $event)"
                                        @delete="deleteComment(post, $event)"
                                        @report="openReportModal('comment', $event)"
                                        @view-profile="viewProfile"
                                    ></comment-item>
                                </template>
                            </div>
                            <div v-else class="empty" style="padding:15px;">{{ t('UI_NO_COMMENTS') || 'No comments yet' }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== PROFILE VIEW ==================== -->
            <div v-if="currentView === 'profile'">
                <button class="btn-secondary back-btn" @click="goBack">&#8592; {{ t('UI_BTN_BACK') || 'Back' }}</button>
                
                <div v-if="profileLoading" class="loading">{{ t('UI_LOADING') }}</div>
                <div v-else-if="viewedProfile" class="card" style="padding:0; overflow:hidden;">
                    <!-- Cover Image -->
                    <div v-if="viewedProfile.cover_url" style="width:100%; height:150px; background:#222;">
                        <img :src="API_BASE + viewedProfile.cover_url" class="cover-image" @error="$event.target.style.display='none'">
                    </div>
                    <div v-else style="width:100%; height:80px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);"></div>
                    
                    <div style="padding:0 20px 20px 20px;">
                        <!-- Avatar and Name -->
                        <div style="display:flex; align-items:flex-end; gap:15px; margin-bottom:10px;">
                            <img v-if="viewedProfile.avatar_url" :src="API_BASE + viewedProfile.avatar_url" class="profile-avatar" @error="$event.target.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23333%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2250%22 text-anchor=%22middle%22 dy=%22.35em%22 fill=%22%23888%22 font-size=%2240%22>?</text></svg>'">
                            <div v-else class="profile-avatar" style="display:flex; align-items:center; justify-content:center; font-size:32px; color:#666;">?</div>
                            <div>
                                <h2 style="color:#4a9eff; margin:0; display:flex; align-items:center;">
                                    {{ viewedProfile.username }}
                                    <span v-if="viewedProfile.is_locked" class="lock-icon">&#128274;</span>
                                </h2>
                            </div>
                        </div>
                        
                        <div class="profile-stats">
                            <span>ID: {{ viewedProfile.id }}</span>
                            <span v-if="viewedProfile.location">{{ viewedProfile.location }}</span>
                            <span v-if="viewedProfile.joined_at">{{ t('UI_LBL_JOINED') || 'Joined' }}: {{ formatJoinDate(viewedProfile.joined_at) }}</span>
                        </div>
                        <div class="profile-bio">{{ viewedProfile.bio || t('UI_NO_BIO') || 'No bio' }}</div>
                        <div v-if="viewedProfile.is_locked" style="color:#f87171; font-size:13px;">{{ t('UI_PRIVATE_PROFILE') || 'This profile is private' }}</div>
                        
                        <div class="profile-actions">
                            <!-- Self Profile -->
                            <template v-if="viewedProfile.friend_status === 'self'">
                                <button class="btn-primary" @click="openEditProfileModal">{{ t('UI_BTN_EDIT') || 'Edit Profile' }}</button>
                            </template>
                            <!-- Friend Actions -->
                            <template v-else>
                                <button v-if="viewedProfile.friend_status === 'none'" class="btn-primary" @click="sendFriendRequest(viewedProfile.id)">
                                    {{ t('UI_BTN_ADD_FRIEND') || 'Add Friend' }}
                                </button>
                                <button v-if="viewedProfile.friend_status === 'pending_sent'" class="btn-secondary" disabled>
                                    {{ t('UI_LBL_REQUEST_SENT') || 'Request Sent' }}
                                </button>
                                <button v-if="viewedProfile.friend_status === 'pending_received'" class="btn-success" @click="respondFriendRequest(viewedProfile.id, 'accept')">
                                    {{ t('UI_BTN_ACCEPT') || 'Accept Request' }}
                                </button>
                                <button v-if="viewedProfile.friend_status === 'friend'" class="btn-danger" @click="removeFriend(viewedProfile.id)">
                                    {{ t('UI_BTN_REMOVE_FRIEND') || 'Remove Friend' }}
                                </button>
                                <button class="btn-danger" @click="openReportModal('user', viewedProfile.id)">{{ t('UI_BTN_REPORT') }}</button>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- User's Posts (Only if not locked OR is friend/self) -->
                <template v-if="viewedProfile && (!viewedProfile.is_locked || viewedProfile.friend_status === 'friend' || viewedProfile.friend_status === 'self')">
                    <h3 style="margin:15px 0;">{{ t('UI_TITLE_POSTS') || 'Posts' }}</h3>
                    <div v-if="profilePosts.length === 0" class="empty">{{ t('UI_NO_POSTS') }}</div>
                    <div v-else>
                        <div v-for="post in profilePosts" :key="post.id" class="card">
                            <div class="post-header">
                                <span class="post-author">{{ viewedProfile.username }}</span>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <span class="post-origin">{{ post.date }}</span>
                                    <button v-if="post.author_id === currentUser.id || currentUser.id === 1" class="btn-danger post-delete-btn" @click="deleteProfilePost(post)">
                                        &#128465;
                                    </button>
                                </div>
                            </div>
                            <div class="post-content">{{ post.content }}</div>
                            <img v-if="post.media_url" :src="API_BASE + post.media_url" class="post-media" @error="$event.target.style.display='none'">
                            <div class="post-actions">
                                <button @click="toggleProfilePostLike(post)" :class="{ liked: post.liked_by_me }">
                                    &#9829; <span class="likes-count">{{ post.likes }}</span> {{ t('UI_LBL_LIKES') }}
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
                <div v-else-if="viewedProfile && viewedProfile.is_locked" class="empty" style="margin-top:20px;">
                    &#128274; {{ t('UI_PRIVATE_PROFILE') || 'This profile is private. Add as friend to see posts.' }}
                </div>
            </div>

            <!-- ==================== COMMUNITY VIEW ==================== -->
            <div v-if="currentView === 'community'">
                <button class="btn-secondary back-btn" @click="currentView = 'communities'; loadCommunities()">&#8592; {{ t('UI_BTN_BACK') || 'Back' }}</button>
                
                <div v-if="communityLoading" class="loading">{{ t('UI_LOADING') }}</div>
                <div v-else-if="viewedCommunity" class="card">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:10px;">
                        <div>
                            <h2 style="color:#4a9eff; margin-bottom:5px;">{{ viewedCommunity.name }}</h2>
                            <p style="color:#888;">{{ viewedCommunity.description || t('UI_NO_DESC') || 'No description' }}</p>
                            <div style="font-size:12px; color:#666; margin-top:5px;">
                                {{ viewedCommunity.members }} {{ t('UI_LBL_MEMBERS') || 'members' }} | {{ viewedCommunity.location }}
                                <span v-if="viewedCommunity.is_private" style="color:#f87171;"> | &#128274; Private</span>
                            </div>
                        </div>
                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                            <!-- Show Join only if NOT already a member -->
                            <button v-if="!viewedCommunity.am_i_member && viewedCommunity.joinStatus !== 'pending'" class="btn-primary" @click="joinCommunityDirect(viewedCommunity)">
                                {{ t('UI_BTN_JOIN') }}
                            </button>
                            <!-- Pending status -->
                            <button v-else-if="viewedCommunity.joinStatus === 'pending'" class="btn-pending" disabled>
                                {{ t('BTN_PENDING') || 'Pending' }}
                            </button>
                            <!-- Leave if member -->
                            <button v-else-if="viewedCommunity.am_i_member" class="btn-danger" @click="leaveCommunityDirect(viewedCommunity)">
                                {{ t('UI_BTN_LEAVE') }}
                            </button>
                            <button v-if="viewedCommunity.am_i_admin" class="btn-secondary" @click="showEditCommunityModal = true">
                                {{ t('UI_BTN_EDIT') || 'Edit' }}
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Community Sub-tabs -->
                <div class="sub-tabs">
                    <button :class="{ active: communitySubView === 'posts' }" @click="communitySubView = 'posts'">{{ t('UI_TITLE_POSTS') || 'Posts' }}</button>
                    <button :class="{ active: communitySubView === 'members' }" @click="communitySubView = 'members'; loadCommunityMembers()">{{ t('UI_LBL_MEMBERS') || 'Members' }}</button>
                    <button v-if="viewedCommunity && (viewedCommunity.am_i_admin || viewedCommunity.am_i_master)" :class="{ active: communitySubView === 'requests' }" @click="communitySubView = 'requests'; loadCommunityRequests()">
                        {{ t('UI_LBL_REQUESTS') || 'Requests' }}
                    </button>
                </div>

                <!-- Community Posts -->
                <div v-if="communitySubView === 'posts'">
                    <!-- Create Post in Community -->
                    <div v-if="viewedCommunity && viewedCommunity.am_i_member" class="card">
                        <div class="form-group">
                            <textarea v-model="newCommunityPost.content" :placeholder="t('UI_WRITE_PLACEHOLDER')" maxlength="300"></textarea>
                        </div>
                        <!-- Image Upload for Community Post -->
                        <div v-if="newCommunityPost.imagePreview" style="margin-bottom:10px;">
                            <img :src="newCommunityPost.imagePreview" class="image-preview">
                            <button @click="clearCommunityPostImage" style="margin-left:10px; font-size:12px;">X {{ t('UI_BTN_REMOVE') || 'Remove' }}</button>
                        </div>
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                            <button class="btn-primary" @click="createCommunityPost" :disabled="!newCommunityPost.content.trim() || newCommunityPost.content.length > 300">
                                {{ t('UI_BTN_SEND') }}
                            </button>
                            <div class="file-input-wrapper">
                                <button class="btn-secondary">{{ t('UI_BTN_MEDIA') || 'Add Image' }}</button>
                                <input type="file" accept="image/*" @change="handleCommunityPostImage">
                            </div>
                            <span class="char-counter" :class="{ warning: newCommunityPost.content.length > 250, danger: newCommunityPost.content.length > 290 }">
                                {{ newCommunityPost.content.length }}/300
                            </span>
                        </div>
                    </div>
                    
                    <div v-if="communityPosts.length === 0" class="empty">{{ t('UI_NO_POSTS') }}</div>
                    <div v-else>
                        <div v-for="post in communityPosts" :key="post.id" class="card">
                            <div class="post-header">
                                <span class="post-author" @click="viewProfile(post.author_id)">{{ post.author }}</span>
                                <span class="post-origin">{{ post.date }}</span>
                            </div>
                            <div class="post-content">{{ post.content }}</div>
                            <img v-if="post.media_url" :src="API_BASE + post.media_url" class="post-media" @error="$event.target.style.display='none'">
                            <div class="post-actions">
                                <button @click="toggleCommunityPostLike(post)" :class="{ liked: post.liked_by_me }">
                                    &#9829; <span class="likes-count">{{ post.likes }}</span> {{ t('UI_LBL_LIKES') }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Community Members -->
                <div v-if="communitySubView === 'members'">
                    <div v-if="communityMembers.length === 0" class="empty">{{ t('UI_NO_MEMBERS') || 'No members' }}</div>
                    <div v-else class="card">
                        <div v-for="member in communityMembers" :key="member.id" class="member-item">
                            <div class="member-info">
                                <span class="post-author" @click="viewProfile(member.id)">{{ member.username }}</span>
                                <span class="member-role" :class="{ master: member.role === 1, admin: member.role === 2 }">
                                    {{ member.role === 1 ? 'Master' : member.role === 2 ? 'Admin' : 'Member' }}
                                </span>
                            </div>
                            <div v-if="viewedCommunity.am_i_master && member.id !== currentUser.id && member.role !== 1" style="display:flex; gap:5px; align-items:center;">
                                <select class="role-select" :value="member.role" @change="changeMemberRole(member.id, $event.target.value)">
                                    <option value="2">Admin</option>
                                    <option value="3">Member</option>
                                </select>
                                <button class="btn-danger" @click="removeMember(member.id)">{{ t('UI_BTN_REMOVE') || 'Remove' }}</button>
                            </div>
                            <div v-else-if="viewedCommunity.am_i_admin && member.id !== currentUser.id && member.role === 3" style="display:flex; gap:5px;">
                                <button v-if="member.role === 3" class="btn-secondary" @click="promoteToAdmin(member.id)">Promote</button>
                                <button class="btn-danger" @click="removeMember(member.id)">Remove</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Community Join Requests (Admin Only) -->
                <div v-if="communitySubView === 'requests'">
                    <div v-if="communityRequests.length === 0" class="empty">{{ t('UI_NO_REQUESTS') || 'No pending requests' }}</div>
                    <div v-else class="card">
                        <div v-for="req in communityRequests" :key="req.id" class="member-item">
                            <div class="member-info">
                                <span class="post-author" @click="viewProfile(req.id)">{{ req.username }}</span>
                                <span style="font-size:12px; color:#666;">{{ req.bio }}</span>
                            </div>
                            <div style="display:flex; gap:5px;">
                                <button class="btn-success" @click="approveCommunityRequest(req.id)">{{ t('UI_BTN_ACCEPT') || 'Accept' }}</button>
                                <button class="btn-danger" @click="respondCommunityRequest(req.id, 'reject')">{{ t('UI_BTN_REJECT') || 'Reject' }}</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== COMMUNITIES LIST VIEW ==================== -->
            <div v-if="currentView === 'communities'">
                <!-- CREATE COMMUNITY -->
                <div class="card">
                    <h3 style="margin-bottom:10px;">{{ t('UI_BTN_CREATE_COMM') }}</h3>
                    <div class="form-group">
                        <label>{{ t('UI_LBL_NAME') || 'Name' }}</label>
                        <input v-model="newCommunity.name" type="text">
                    </div>
                    <div class="form-group">
                        <label>{{ t('UI_LBL_DESC') || 'Description' }}</label>
                        <textarea v-model="newCommunity.description" style="min-height:50px;"></textarea>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="new_comm_private" v-model="newCommunity.is_private">
                        <label for="new_comm_private">{{ t('UI_LBL_PRIVATE') || 'Private Community' }}</label>
                    </div>
                    <button class="btn-success" @click="createCommunity" :disabled="!newCommunity.name.trim()">
                        {{ t('UI_BTN_CREATE_COMM') }}
                    </button>
                </div>

                <!-- COMMUNITIES LIST -->
                <h3 style="margin:15px 0;">{{ t('UI_TITLE_COMM') }}</h3>
                <div v-if="loading" class="loading">{{ t('UI_LOADING') }}</div>
                <div v-else-if="communities.length === 0" class="empty">{{ t('UI_NO_COMMUNITIES') }}</div>
                <div v-else>
                    <div v-for="comm in communities" :key="comm.id" class="card community-card">
                        <div class="community-info">
                            <h3 @click="viewCommunity(comm.id)">
                                {{ comm.name }}
                                <span v-if="comm.is_private" style="color:#f87171; font-size:14px;"> &#128274;</span>
                            </h3>
                            <p>{{ comm.description || t('UI_NO_DESC') || 'No description' }}</p>
                            <div class="community-meta">
                                {{ comm.members }} {{ t('UI_LBL_MEMBERS') || 'members' }} | {{ comm.location }}
                            </div>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-secondary" @click="viewCommunity(comm.id)">{{ t('UI_BTN_VIEW') || 'View' }}</button>
                            <!-- Show Join only if NOT member and NOT pending -->
                            <button v-if="!comm.isMember && comm.joinStatus !== 'pending'" class="btn-primary" @click="joinCommunity(comm)">
                                {{ t('UI_BTN_JOIN') }}
                            </button>
                            <!-- Pending status -->
                            <button v-else-if="comm.joinStatus === 'pending'" class="btn-pending" disabled>
                                {{ t('BTN_PENDING') || 'Pending' }}
                            </button>
                            <!-- Leave if member -->
                            <button v-else-if="comm.isMember" class="btn-danger" @click="leaveCommunity(comm)">
                                {{ t('UI_BTN_LEAVE') }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== FRIENDS VIEW ==================== -->
            <div v-if="currentView === 'friends'">
                <!-- Sub-tabs -->
                <div class="sub-tabs">
                    <button :class="{ active: friendsSubView === 'list' }" @click="friendsSubView = 'list'">{{ t('UI_TAB_MY_FRIENDS') || 'My Friends' }}</button>
                    <button :class="{ active: friendsSubView === 'pending' }" @click="friendsSubView = 'pending'; loadPendingRequests()">
                        {{ t('UI_TAB_PENDING') || 'Pending' }}
                        <span v-if="pendingRequests.length > 0" class="badge unread">{{ pendingRequests.length }}</span>
                    </button>
                    <button :class="{ active: friendsSubView === 'search' }" @click="friendsSubView = 'search'">{{ t('UI_TAB_SEARCH') || 'Search' }}</button>
                </div>

                <!-- Friends List -->
                <div v-if="friendsSubView === 'list'">
                    <div v-if="friends.length === 0" class="empty">{{ t('UI_NO_FRIENDS') || 'No friends yet' }}</div>
                    <div v-else>
                        <div v-for="friend in friends" :key="friend.id" class="friend-item">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <img v-if="friend.avatar_url" :src="API_BASE + friend.avatar_url" class="profile-avatar-small" @error="$event.target.style.display='none'">
                                <div>
                                    <span class="post-author" @click="viewProfile(friend.id)">{{ friend.username }}</span>
                                    <p style="font-size:12px; color:#666;">{{ friend.bio }}</p>
                                </div>
                            </div>
                            <button class="btn-danger" @click="removeFriend(friend.id)">{{ t('UI_BTN_REMOVE') || 'Remove' }}</button>
                        </div>
                    </div>
                </div>

                <!-- Pending Requests -->
                <div v-if="friendsSubView === 'pending'">
                    <div v-if="pendingRequests.length === 0" class="empty">{{ t('UI_NO_REQUESTS') || 'No pending requests' }}</div>
                    <div v-else>
                        <div v-for="req in pendingRequests" :key="req.id" class="friend-item">
                            <div>
                                <span class="post-author" @click="viewProfile(req.id)">{{ req.username }}</span>
                            </div>
                            <div style="display:flex; gap:5px;">
                                <button class="btn-success" @click="respondFriendRequest(req.id, 'accept')">{{ t('UI_BTN_ACCEPT') || 'Accept' }}</button>
                                <button class="btn-danger" @click="respondFriendRequest(req.id, 'reject')">{{ t('UI_BTN_REJECT') || 'Reject' }}</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search Users -->
                <div v-if="friendsSubView === 'search'">
                    <div class="search-box">
                        <input v-model="searchQuery" type="text" :placeholder="t('UI_PLACEHOLDER_SEARCH') || 'Search users...'" @keyup.enter="searchUsers">
                        <button class="btn-primary" @click="searchUsers">{{ t('UI_BTN_SEARCH') || 'Search' }}</button>
                    </div>
                    <div v-if="searchResults.length === 0 && searchQuery && searchPerformed" class="empty">{{ t('UI_NO_RESULTS') || 'No results found' }}</div>
                    <div v-else>
                        <div v-for="user in searchResults" :key="user.id" class="friend-item">
                            <div>
                                <span class="post-author" @click="viewProfile(user.id)">{{ user.username }}</span>
                                <p style="font-size:12px; color:#666;">{{ user.bio }}</p>
                            </div>
                            <button class="btn-primary" @click="sendFriendRequest(user.id)">{{ t('UI_BTN_ADD_FRIEND') || 'Add' }}</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== NOTIFICATIONS VIEW ==================== -->
            <div v-if="currentView === 'notifications'">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3>{{ t('UI_NAV_NOTIFICATIONS') }}</h3>
                    <button v-if="notifications.length > 0" @click="markAllRead">{{ t('UI_BTN_MARK_READ') || 'Mark all as read' }}</button>
                </div>
                <div v-if="loading" class="loading">{{ t('UI_LOADING') }}</div>
                <div v-else-if="notifications.length === 0" class="empty">{{ t('UI_NO_NOTIFS') }}</div>
                <div v-else>
                    <div v-for="notif in notifications" :key="notif.id" class="card notification" :class="{ unread: !notif.is_read, read: notif.is_read }" @click="handleNotificationClick(notif)">
                        <div style="display:flex; justify-content:space-between;">
                            <span>{{ notif.message }}</span>
                            <span style="font-size:12px; color:#666;">{{ notif.created_at }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== ADMIN VIEW ==================== -->
            <div v-if="currentView === 'admin'">
                <h3 style="margin-bottom:15px;">{{ t('UI_TITLE_ADMIN') || 'Admin Panel - Reports' }}</h3>
                <div v-if="reports.length === 0" class="empty">{{ t('UI_NO_REPORTS') || 'No pending reports' }}</div>
                <div v-else>
                    <div v-for="report in reports" :key="report.id" class="card report-item">
                        <div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px;">
                            <div>
                                <strong>{{ t('UI_LBL_TYPE') || 'Type' }}: </strong>
                                <span>{{ report.type === 1 ? 'User' : report.type === 2 ? 'Post' : 'Comment' }}</span>
                            </div>
                            <div>
                                <strong>{{ t('UI_LBL_TARGET') || 'Target ID' }}: </strong>
                                <span>{{ report.target_id }}</span>
                            </div>
                            <div>
                                <strong>{{ t('UI_LBL_CATEGORY') || 'Category' }}: </strong>
                                <span>{{ report.category === 1 ? 'Spam' : report.category === 2 ? 'Hate' : 'Fake' }}</span>
                            </div>
                        </div>
                        <div style="margin-top:10px;">
                            <strong>{{ t('UI_LBL_REASON') }}: </strong>
                            <span>{{ report.reason }}</span>
                        </div>
                        <div class="report-meta">
                            {{ t('UI_LBL_REPORTER') || 'Reporter' }}: {{ report.reporter_id }} | {{ report.date }}
                        </div>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button class="btn-success" @click="resolveReport(report.id, 1)">{{ t('UI_BTN_RESOLVE') || 'Resolve' }}</button>
                            <button class="btn-secondary" @click="resolveReport(report.id, 2)">{{ t('UI_BTN_IGNORE') || 'Ignore' }}</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== MODALS ==================== -->

        <!-- REPORT MODAL -->
        <div v-if="showReportModal" class="modal-overlay" @click.self="showReportModal = false">
            <div class="modal">
                <h3>{{ t('UI_TITLE_REPORT') }}</h3>
                <div class="form-group">
                    <label>{{ t('UI_LBL_CATEGORY') || 'Category' }}</label>
                    <select v-model="reportForm.category">
                        <option value="1">{{ t('UI_OPT_SPAM') }}</option>
                        <option value="2">{{ t('UI_OPT_HATE') }}</option>
                        <option value="3">{{ t('UI_OPT_FAKE') }}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>{{ t('UI_LBL_REASON') }}</label>
                    <textarea v-model="reportForm.reason" :placeholder="t('UI_PLACEHOLDER_REASON') || 'Describe the issue...'"></textarea>
                </div>
                <div class="modal-actions">
                    <button @click="showReportModal = false">{{ t('UI_BTN_CANCEL') }}</button>
                    <button class="btn-danger" @click="submitReport" :disabled="!reportForm.reason.trim()">
                        {{ t('UI_BTN_REPORT') }}
                    </button>
                </div>
            </div>
        </div>

        <!-- SIGNUP SUCCESS MODAL -->
        <div v-if="showSignupModal" class="modal-overlay">
            <div class="modal">
                <h3 style="color:#4ade80;">{{ t('MSG_CREATED') }}</h3>
                <p style="margin:15px 0; text-align:center;">
                    {{ t('UI_LBL_YOUR_ID') || 'Your User ID is' }}: <strong style="font-size:24px; color:#4a9eff;">{{ signupUserId }}</strong>
                </p>
                <p style="font-size:13px; color:#888; text-align:center;">
                    {{ t('UI_MSG_SAVE_ID') || 'Save this ID! You will need it to login.' }}
                </p>
                <div class="modal-actions" style="justify-content:center;">
                    <button class="btn-primary" @click="showSignupModal = false; isRegistering = false;">{{ t('UI_BTN_OK') || 'OK, I saved it' }}</button>
                </div>
            </div>
        </div>

        <!-- EDIT PROFILE MODAL -->
        <div v-if="showEditProfileModal" class="modal-overlay" @click.self="showEditProfileModal = false">
            <div class="modal">
                <h3>{{ t('UI_TITLE_EDIT_PROFILE') || 'Edit Profile' }}</h3>
                
                <!-- Avatar Upload -->
                <div class="form-group">
                    <label>Avatar</label>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <img v-if="editProfileForm.avatarPreview || currentUser.avatar_url" 
                             :src="editProfileForm.avatarPreview || (API_BASE + currentUser.avatar_url)" 
                             style="width:60px; height:60px; border-radius:50%; object-fit:cover;"
                             @error="$event.target.style.display='none'">
                        <div class="file-input-wrapper">
                            <button class="btn-secondary">{{ t('UI_BTN_MEDIA') || 'Upload' }}</button>
                            <input type="file" accept="image/*" @change="handleAvatarUpload">
                        </div>
                    </div>
                </div>
                
                <!-- Cover Upload -->
                <div class="form-group">
                    <label>Cover Photo</label>
                    <div>
                        <img v-if="editProfileForm.coverPreview || currentUser.cover_url" 
                             :src="editProfileForm.coverPreview || (API_BASE + currentUser.cover_url)" 
                             style="width:100%; max-height:100px; object-fit:cover; border-radius:4px; margin-bottom:10px;"
                             @error="$event.target.style.display='none'">
                        <div class="file-input-wrapper">
                            <button class="btn-secondary">{{ t('UI_BTN_MEDIA') || 'Upload Cover' }}</button>
                            <input type="file" accept="image/*" @change="handleCoverUpload">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>{{ t('UI_LBL_BIO') || 'Bio' }}</label>
                    <textarea v-model="editProfileForm.bio" style="min-height:60px;"></textarea>
                </div>
                <div class="form-group">
                    <label>{{ t('UI_LBL_EMAIL') }}</label>
                    <input v-model="editProfileForm.email" type="email">
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="is_private" v-model="editProfileForm.is_private">
                    <label for="is_private">{{ t('UI_LBL_PRIVATE') || 'Private Profile' }}</label>
                </div>
                <div class="modal-actions">
                    <button @click="showEditProfileModal = false">{{ t('UI_BTN_CANCEL') }}</button>
                    <button class="btn-primary" @click="saveProfile">{{ t('UI_BTN_SAVE') || 'Save' }}</button>
                </div>
                
                <!-- DANGER ZONE -->
                <div class="danger-zone">
                    <h4>&#9888; Danger Zone</h4>
                    <p style="font-size:12px; color:#888; margin-bottom:10px;">{{ t('MSG_USER_DELETED') || 'This action is permanent and cannot be undone.' }}</p>
                    <button class="btn-danger" @click="deleteAccount">{{ t('UI_BTN_DELETE') || 'Delete Account' }}</button>
                </div>
            </div>
        </div>

        <!-- EDIT COMMUNITY MODAL -->
        <div v-if="showEditCommunityModal" class="modal-overlay" @click.self="showEditCommunityModal = false">
            <div class="modal">
                <h3>{{ t('UI_TITLE_EDIT_COMM') || 'Edit Community' }}</h3>
                <div class="form-group">
                    <label>{{ t('UI_LBL_DESC') || 'Description' }}</label>
                    <textarea v-model="editCommunityForm.description" style="min-height:60px;"></textarea>
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="comm_private" v-model="editCommunityForm.is_private">
                    <label for="comm_private">{{ t('UI_LBL_PRIVATE') || 'Private Community' }}</label>
                </div>
                <div class="modal-actions">
                    <button @click="showEditCommunityModal = false">{{ t('UI_BTN_CANCEL') }}</button>
                    <button class="btn-primary" @click="saveCommunity">{{ t('UI_BTN_SAVE') || 'Save' }}</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, computed, onMounted, onUnmounted } = Vue;

        const API_BASE = 'https://unrodded-florencia-unkemptly.ngrok-free.dev';

        // Comment Item Component for Recursive Rendering
        const CommentItem = {
            name: 'CommentItem',
            props: ['comment', 'post', 'currentUser', 'depth', 't'],
            emits: ['reply', 'like', 'delete', 'report', 'viewProfile'],
            template: `
                <div class="comment" :class="'depth-' + Math.min(depth, 3)">
                    <div class="comment-header">
                        <span class="comment-author" @click="$emit('viewProfile', comment.author_id)">{{ comment.author_name || 'Unknown' }}</span>
                        <span style="color:#666;">{{ comment.created_at }}</span>
                    </div>
                    <div>{{ comment.content }}</div>
                    <div class="comment-actions">
                        <button @click="$emit('like', comment)" :class="{ liked: comment.liked_by_me }">
                            &#9829; {{ comment.likes || 0 }}
                        </button>
                        <button @click="$emit('reply', comment)">{{ t('UI_BTN_REPLY') }}</button>
                        <button v-if="comment.author_id === currentUser.id || post.author_id === currentUser.id" class="btn-danger" @click="$emit('delete', comment)">
                            {{ t('UI_BTN_DEL_SHORT') }}
                        </button>
                        <button @click="$emit('report', comment.id)">{{ t('UI_BTN_REPORT') }}</button>
                    </div>
                    <div v-if="comment.replies && comment.replies.length > 0" style="margin-top:10px;">
                        <comment-item 
                            v-for="reply in comment.replies" 
                            :key="reply.id"
                            :comment="reply" 
                            :post="post" 
                            :current-user="currentUser"
                            :depth="depth + 1"
                            :t="t"
                            @reply="$emit('reply', $event)"
                            @like="$emit('like', $event)"
                            @delete="$emit('delete', $event)"
                            @report="$emit('report', $event)"
                            @view-profile="$emit('viewProfile', $event)"
                        ></comment-item>
                    </div>
                </div>
            `
        };

        const app = createApp({
            components: { CommentItem },
            setup() {
                // --- STATE ---
                const translations = ref({});
                const isLoggedIn = ref(false);
                const isRegistering = ref(false);
                const loading = ref(false);
                const currentView = ref('feed');
                const previousView = ref('feed');
                const currentUser = ref({ id: null, username: '', avatar_url: '', cover_url: '', bio: '', role: '', is_private: false });
                const token = ref('');
                
                // Geographic Data
                const serverStates = ref([]);
                const serverCities = ref([]);
                
                // Language (Default 1 = PT_BR)
                const currentLang = ref(1); 

                // Auth forms
                const loginForm = reactive({ identifier: '', password: '' });
                const signupForm = reactive({ username: '', email: '', password: '', city: '', state: '' });
                const authError = ref('');
                const authSuccess = ref('');
                const showSignupModal = ref(false);
                const signupUserId = ref(null);

                // Data
                const posts = ref([]);
                const communities = ref([]);
                const notifications = ref([]);
                const unreadCount = computed(() => notifications.value.filter(n => !n.is_read).length);
                const newPost = reactive({ content: '', community_id: null, imageBase64: '', imagePreview: '' });
                const newCommunity = reactive({ name: '', description: '', is_private: false });
                const showReportModal = ref(false);
                const reportForm = reactive({ target_id: null, type: null, category: 1, reason: '' });

                // Profile View
                const viewedProfile = ref(null);
                const profilePosts = ref([]);
                const profileLoading = ref(false);
                const showEditProfileModal = ref(false);
                const editProfileForm = reactive({ bio: '', email: '', is_private: false, avatarBase64: '', coverBase64: '', avatarPreview: '', coverPreview: '' });

                // Community View
                const viewedCommunity = ref(null);
                const communityPosts = ref([]);
                const communityMembers = ref([]);
                const communityRequests = ref([]);
                const communityLoading = ref(false);
                const communitySubView = ref('posts');
                const newCommunityPost = reactive({ content: '', imageBase64: '', imagePreview: '' });
                const showEditCommunityModal = ref(false);
                const editCommunityForm = reactive({ description: '', is_private: false });

                // Friends
                const friends = ref([]);
                const pendingRequests = ref([]);
                const searchResults = ref([]);
                const searchQuery = ref('');
                const friendsSubView = ref('list');
                const searchPerformed = ref(false);

                // Admin
                const reports = ref([]);

                // Toast
                const toast = reactive({ show: false, message: '' });
                let toastTimeout = null;

                // Notification Polling
                let pollInterval = null;
                let lastUnreadCount = 0;

                // --- TRANSLATION HELPER ---
                const t = (key) => translations.value[key] || `[${key}]`;

                // --- TOAST HELPER ---
                const showToast = (message) => {
                    toast.message = message;
                    toast.show = true;
                    if (toastTimeout) clearTimeout(toastTimeout);
                    toastTimeout = setTimeout(() => { toast.show = false; }, 3000);
                };

                // --- API HELPER ---
                const api = async (endpoint, options = {}) => {
                    const headers = { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' };
                    if (token.value) headers['Authorization'] = `Bearer ${token.value}`;
                    try {
                        const res = await fetch(`${API_BASE}${endpoint}`, { ...options, headers: { ...headers, ...options.headers } });
                        const text = await res.text();
                        let data;
                        try { data = JSON.parse(text); } catch { data = text; }
                        if (!res.ok) throw new Error(typeof data === 'string' ? data : data.message || 'Error');
                        return data;
                    } catch (err) {
                        console.error('API Error:', err);
                        throw err;
                    }
                };

                // --- FILE TO BASE64 HELPER ---
                const fileToBase64 = (file) => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = error => reject(error);
                    });
                };

                // --- DATE FORMAT HELPER ---
                const formatJoinDate = (dateStr) => {
                    if (!dateStr) return '';
                    try {
                        const date = new Date(dateStr);
                        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        return `${months[date.getMonth()]} ${date.getFullYear()}`;
                    } catch (e) {
                        return dateStr;
                    }
                };

                // --- GEOGRAPHIC DATA ---
                const loadStates = async () => {
                    try { serverStates.value = await api('/api/states'); } catch (e) {}
                };

                const loadCities = async (state) => {
                    if(!state) return;
                    try { serverCities.value = await api(`/api/cities/${state}`); } catch (e) {}
                };

                // --- LANGUAGE ---
                const changeLanguage = async () => {
                    const langInt = parseInt(currentLang.value);
                    try {
                        await api('/api/language', { 
                            method: 'POST', 
                            body: JSON.stringify({ lang: langInt }) 
                        });
                        localStorage.setItem('user_lang', langInt);
                        await loadTranslations();
                        await loadStates();
                        signupForm.state = '';
                        signupForm.city = '';
                        serverCities.value = [];
                    } catch (e) { console.error(e); }
                };

                const loadTranslations = async () => {
                    try { translations.value = await api('/api/translations'); } catch (e) {}
                };

                // --- AUTH ---
                const login = async () => {
                    if (!loginForm.identifier || !loginForm.password) {
                        authError.value = t('ERR_MISSING') || 'Please fill all fields';
                        return;
                    }
                    loading.value = true;
                    authError.value = '';
                    try {
                        // Send identifier (can be username OR email) per API spec
                        const data = await api('/api/login', {
                            method: 'POST',
                            body: JSON.stringify({ identifier: loginForm.identifier, password: loginForm.password })
                        });
                        token.value = data.token;
                        // Store all returned data from login response
                        currentUser.value = { 
                            id: data.id, 
                            username: data.username, 
                            avatar_url: data.avatar_url || '',
                            cover_url: data.cover_url || '',
                            bio: data.bio || '',
                            role: data.role || '',
                            is_private: data.is_private || false
                        };
                        localStorage.setItem('token', data.token);
                        localStorage.setItem('user', JSON.stringify(currentUser.value));
                        isLoggedIn.value = true;
                        loadFeed();
                        startNotificationPolling();
                    } catch (e) {
                        authError.value = e.message || t('ERR_AUTH_FAILED') || 'Login failed';
                    } finally {
                        loading.value = false;
                    }
                };

                const signup = async () => {
                    if (!signupForm.username || !signupForm.email || !signupForm.password) {
                        authError.value = t('ERR_MISSING') || 'Please fill required fields';
                        return;
                    }
                    loading.value = true;
                    authError.value = '';
                    try {
                        const payload = {
                            username: signupForm.username,
                            email: signupForm.email,
                            password: signupForm.password
                        };
                        if (signupForm.city) payload.city = signupForm.city;
                        if (signupForm.state) payload.state = signupForm.state;

                        const data = await api('/api/signup', {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });
                        
                        signupUserId.value = data.id;
                        showSignupModal.value = true;
                        
                        signupForm.username = '';
                        signupForm.email = '';
                        signupForm.password = '';
                        signupForm.city = '';
                        signupForm.state = '';
                    } catch (e) {
                        authError.value = e.message || t('ERR_SIGNUP') || 'Signup failed';
                    } finally {
                        loading.value = false;
                    }
                };

                const logout = () => {
                    token.value = '';
                    currentUser.value = { id: null, username: '', avatar_url: '', cover_url: '', bio: '', role: '', is_private: false };
                    isLoggedIn.value = false;
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    stopNotificationPolling();
                };

                const checkAuth = () => {
                    const savedToken = localStorage.getItem('token');
                    const savedUser = localStorage.getItem('user');
                    if (savedToken && savedUser) {
                        token.value = savedToken;
                        currentUser.value = JSON.parse(savedUser);
                        isLoggedIn.value = true;
                        return true;
                    }
                    return false;
                };

                // --- NAVIGATION ---
                const goToFeed = () => {
                    currentView.value = 'feed';
                    loadFeed();
                };

                const goBack = () => {
                    currentView.value = previousView.value || 'feed';
                    if (currentView.value === 'feed') loadFeed();
                };

                const viewProfile = async (userId) => {
                    previousView.value = currentView.value;
                    currentView.value = 'profile';
                    profileLoading.value = true;
                    viewedProfile.value = null;
                    profilePosts.value = [];

                    try {
                        viewedProfile.value = await api(`/api/users/${userId}`);
                        
                        // Check privacy: if is_locked AND not friend AND not self, hide timeline
                        const canSeePosts = !viewedProfile.value.is_locked || 
                                           viewedProfile.value.friend_status === 'friend' || 
                                           viewedProfile.value.friend_status === 'self';
                        
                        if (canSeePosts) {
                            const postsData = await api(`/api/users/${userId}/posts`);
                            profilePosts.value = Array.isArray(postsData) ? postsData.map(p => ({ ...p, liked_by_me: p.liked_by_me || false })) : [];
                        }
                    } catch (e) {
                        console.error('Failed to load profile:', e);
                    } finally {
                        profileLoading.value = false;
                    }
                };

                // Open Edit Profile Modal with pre-filled data from currentUser
                const openEditProfileModal = () => {
                    editProfileForm.bio = currentUser.value.bio || '';
                    editProfileForm.email = '';
                    editProfileForm.is_private = currentUser.value.is_private || false;
                    editProfileForm.avatarBase64 = '';
                    editProfileForm.coverBase64 = '';
                    editProfileForm.avatarPreview = '';
                    editProfileForm.coverPreview = '';
                    showEditProfileModal.value = true;
                };

                const viewCommunity = async (commId) => {
                    previousView.value = currentView.value;
                    currentView.value = 'community';
                    communityLoading.value = true;
                    communitySubView.value = 'posts';
                    viewedCommunity.value = null;
                    communityPosts.value = [];
                    communityMembers.value = [];
                    communityRequests.value = [];

                    try {
                        // Get community info from list or fetch details
                        const commList = await api('/api/communities');
                        const comm = commList.find(c => c.id === commId);
                        if (comm) {
                            viewedCommunity.value = {
                                ...comm,
                                am_i_member: false,
                                am_i_admin: false,
                                am_i_master: false,
                                joinStatus: null
                            };
                        }

                        // Load community posts
                        try {
                            communityPosts.value = await api(`/api/communities/${commId}/posts?viewer=${currentUser.value.id}`);
                        } catch (e) {
                            communityPosts.value = [];
                        }

                        // Load members to check if user is member/admin
                        const members = await api(`/api/communities/${commId}/members`);
                        const myMembership = members.find(m => m.id === currentUser.value.id);
                        if (myMembership) {
                            viewedCommunity.value.am_i_member = true;
                            viewedCommunity.value.am_i_admin = myMembership.role <= 2; // Master=1, Admin=2
                            viewedCommunity.value.am_i_master = myMembership.role === 1;
                        }
                        
                        // Set edit form
                        editCommunityForm.description = viewedCommunity.value.description || '';
                        editCommunityForm.is_private = viewedCommunity.value.is_private || false;

                    } catch (e) {
                        console.error('Failed to load community:', e);
                    } finally {
                        communityLoading.value = false;
                    }
                };

                // --- FEED ---
                const loadFeed = async () => {
                    loading.value = true;
                    try {
                        const data = await api('/api/feed');
                        posts.value = Array.isArray(data) ? data.map(p => ({
                            ...p,
                            showComments: false,
                            comments: [],
                            newComment: '',
                            replyingTo: null
                        })) : [];
                    } catch (e) {
                        console.error('Failed to load feed:', e);
                        posts.value = [];
                    } finally {
                        loading.value = false;
                    }
                };

                // --- POST IMAGE HANDLERS ---
                const handlePostImage = async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        newPost.imageBase64 = await fileToBase64(file);
                        newPost.imagePreview = newPost.imageBase64;
                    }
                };

                const clearPostImage = () => {
                    newPost.imageBase64 = '';
                    newPost.imagePreview = '';
                };

                const handleCommunityPostImage = async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        newCommunityPost.imageBase64 = await fileToBase64(file);
                        newCommunityPost.imagePreview = newCommunityPost.imageBase64;
                    }
                };

                const clearCommunityPostImage = () => {
                    newCommunityPost.imageBase64 = '';
                    newCommunityPost.imagePreview = '';
                };

                const createPost = async () => {
                    if (!newPost.content.trim() || newPost.content.length > 300) return;
                    try {
                        const payload = { content: newPost.content };
                        if (newPost.imageBase64) {
                            payload.media_base64 = newPost.imageBase64;
                        }
                        await api('/api/posts', {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });
                        newPost.content = '';
                        newPost.imageBase64 = '';
                        newPost.imagePreview = '';
                        loadFeed();
                    } catch (e) {
                        alert(e.message || 'Failed to create post');
                    }
                };

                const deletePost = async (post) => {
                    if (!confirm(t('UI_CONFIRM_DELETE') || 'Delete this post?')) return;
                    try {
                        await api(`/api/posts/${post.id}`, { method: 'DELETE' });
                        posts.value = posts.value.filter(p => p.id !== post.id);
                        showToast(t('MSG_SAVED') || 'Post deleted!');
                    } catch (e) {
                        alert(e.message || 'Failed to delete post');
                    }
                };

                const deleteProfilePost = async (post) => {
                    if (!confirm(t('UI_CONFIRM_DELETE') || 'Delete this post?')) return;
                    try {
                        await api(`/api/posts/${post.id}`, { method: 'DELETE' });
                        profilePosts.value = profilePosts.value.filter(p => p.id !== post.id);
                        showToast(t('MSG_SAVED') || 'Post deleted!');
                    } catch (e) {
                        alert(e.message || 'Failed to delete post');
                    }
                };

                // Optimistic UI for likes
                const toggleLike = async (post) => {
                    const wasLiked = post.liked_by_me;
                    // Optimistic update
                    post.liked_by_me = !wasLiked;
                    post.likes = wasLiked ? post.likes - 1 : post.likes + 1;
                    try {
                        await api('/api/likes', {
                            method: 'POST',
                            body: JSON.stringify({ post_id: post.id })
                        });
                    } catch (e) {
                        // Revert on error
                        post.liked_by_me = wasLiked;
                        post.likes = wasLiked ? post.likes + 1 : post.likes - 1;
                        console.error('Failed to toggle like:', e);
                    }
                };

                const toggleProfilePostLike = async (post) => {
                    const wasLiked = post.liked_by_me;
                    // Optimistic update
                    post.liked_by_me = !wasLiked;
                    post.likes = wasLiked ? post.likes - 1 : post.likes + 1;
                    try {
                        await api('/api/likes', {
                            method: 'POST',
                            body: JSON.stringify({ post_id: post.id })
                        });
                    } catch (e) {
                        // Revert on error
                        post.liked_by_me = wasLiked;
                        post.likes = wasLiked ? post.likes + 1 : post.likes - 1;
                        console.error('Failed to toggle like:', e);
                    }
                };

                const toggleCommunityPostLike = async (post) => {
                    const wasLiked = post.liked_by_me;
                    // Optimistic update
                    post.liked_by_me = !wasLiked;
                    post.likes = wasLiked ? post.likes - 1 : post.likes + 1;
                    try {
                        await api('/api/likes', {
                            method: 'POST',
                            body: JSON.stringify({ post_id: post.id })
                        });
                    } catch (e) {
                        // Revert on error
                        post.liked_by_me = wasLiked;
                        post.likes = wasLiked ? post.likes + 1 : post.likes - 1;
                        console.error('Failed to toggle like:', e);
                    }
                };

                // --- COMMENTS ---
                const toggleComments = async (post) => {
                    post.showComments = !post.showComments;
                    if (post.showComments && (!post.comments || post.comments.length === 0)) {
                        await loadComments(post);
                    }
                };

                const loadComments = async (post) => {
                    try {
                        const data = await api(`/api/posts/${post.id}/comments`);
                        // Map the response correctly based on API response
                        post.comments = Array.isArray(data) ? data.map(c => ({
                            id: c.id,
                            author_id: c.author_id,
                            author_name: c.author_name || 'Unknown',
                            author_avatar: c.author_avatar || '',
                            content: c.content,
                            created_at: c.created_at,
                            parent_id: c.parent_id || null,
                            likes: c.likes || 0,
                            liked_by_me: c.liked_by_me || false
                        })) : [];
                        post.comments_count = post.comments.length;
                    } catch (e) {
                        console.error('Failed to load comments:', e);
                        post.comments = [];
                    }
                };

                const buildCommentTree = (comments) => {
                    if (!comments || !Array.isArray(comments)) return [];
                    const map = {};
                    const roots = [];
                    
                    comments.forEach(c => {
                        map[c.id] = { ...c, replies: [] };
                    });
                    
                    comments.forEach(c => {
                        if (c.parent_id && map[c.parent_id]) {
                            map[c.parent_id].replies.push(map[c.id]);
                        } else if (!c.parent_id) {
                            roots.push(map[c.id]);
                        } else {
                            roots.push(map[c.id]);
                        }
                    });
                    
                    return roots;
                };

                const setReplyTo = (post, comment) => {
                    post.replyingTo = comment;
                    post.newComment = '';
                };

                const cancelReply = (post) => {
                    post.replyingTo = null;
                };

                const submitComment = async (post) => {
                    if (!post.newComment || !post.newComment.trim() || post.newComment.length > 200) return;
                    try {
                        const payload = {
                            post_id: post.id,
                            content: post.newComment
                        };
                        if (post.replyingTo) {
                            payload.parent_id = post.replyingTo.id;
                        }
                        await api('/api/comments', {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });
                        post.newComment = '';
                        post.replyingTo = null;
                        await loadComments(post);
                    } catch (e) {
                        alert(e.message || 'Failed to submit comment');
                    }
                };

                const toggleCommentLike = async (post, comment) => {
                    try {
                        await api('/api/comments/like', {
                            method: 'POST',
                            body: JSON.stringify({ comment_id: comment.id })
                        });
                        comment.liked_by_me = !comment.liked_by_me;
                        comment.likes = comment.liked_by_me ? (comment.likes || 0) + 1 : (comment.likes || 1) - 1;
                    } catch (e) {
                        console.error('Failed to toggle comment like:', e);
                    }
                };

                const deleteComment = async (post, comment) => {
                    if (!confirm(t('UI_CONFIRM_DELETE') || 'Delete this comment?')) return;
                    try {
                        await api(`/api/comments/${comment.id}`, { method: 'DELETE' });
                        await loadComments(post);
                    } catch (e) {
                        alert(e.message || 'Failed to delete comment');
                    }
                };

                // --- COMMUNITIES ---
                const loadCommunities = async () => {
                    loading.value = true;
                    try {
                        const data = await api('/api/communities');
                        // Load member info to determine if user is a member
                        const memberships = await Promise.all(
                            data.map(async (c) => {
                                try {
                                    const members = await api(`/api/communities/${c.id}/members`);
                                    return members.some(m => m.id === currentUser.value.id);
                                } catch { return false; }
                            })
                        );
                        communities.value = data.map((c, i) => ({ ...c, isMember: memberships[i], joinStatus: null }));
                    } catch (e) {
                        console.error('Failed to load communities:', e);
                        communities.value = [];
                    } finally {
                        loading.value = false;
                    }
                };

                const createCommunity = async () => {
                    if (!newCommunity.name.trim()) return;
                    try {
                        await api('/api/communities', {
                            method: 'POST',
                            body: JSON.stringify({
                                name: newCommunity.name,
                                description: newCommunity.description,
                                is_private: newCommunity.is_private
                            })
                        });
                        newCommunity.name = '';
                        newCommunity.description = '';
                        newCommunity.is_private = false;
                        loadCommunities();
                        showToast(t('MSG_COMM_CREATED') || 'Community created!');
                    } catch (e) {
                        alert(e.message || 'Failed to create community');
                    }
                };

                // FIXED: Call POST /api/communities/request per API spec
                const joinCommunity = async (comm) => {
                    try {
                        const res = await api('/api/communities/request', {
                            method: 'POST',
                            body: JSON.stringify({ community_id: comm.id })
                        });
                        // Check response text per API: "JOINED_DIRECTLY" or "REQUEST_SENT"
                        if (res === 'JOINED_DIRECTLY' || (typeof res === 'string' && res.includes('JOINED'))) {
                            comm.isMember = true;
                            comm.members++;
                            comm.joinStatus = null;
                            showToast(t('MSG_COMM_JOINED') || 'Joined!');
                        } else if (res === 'REQUEST_SENT' || (typeof res === 'string' && res.includes('REQUEST'))) {
                            comm.joinStatus = 'pending';
                            showToast(t('MSG_REQ_SENT') || 'Request sent!');
                        } else {
                            showToast(t('MSG_COMM_JOINED') || 'Joined!');
                            comm.isMember = true;
                        }
                    } catch (e) {
                        alert(e.message || 'Failed to join community');
                    }
                };

                const leaveCommunity = async (comm) => {
                    if (!confirm(t('UI_CONFIRM_LEAVE') || 'Leave this community?')) return;
                    try {
                        await api('/api/communities/leave', {
                            method: 'POST',
                            body: JSON.stringify({ community_id: comm.id })
                        });
                        comm.isMember = false;
                        comm.members--;
                        comm.joinStatus = null;
                    } catch (e) {
                        alert(e.message || 'Failed to leave community');
                    }
                };

                const joinCommunityDirect = async (comm) => {
                    await joinCommunity(comm);
                    if (comm.isMember) {
                        comm.am_i_member = true;
                    }
                };

                const leaveCommunityDirect = async (comm) => {
                    if (!confirm(t('UI_CONFIRM_LEAVE') || 'Leave this community?')) return;
                    try {
                        await api('/api/communities/leave', {
                            method: 'POST',
                            body: JSON.stringify({ community_id: comm.id })
                        });
                        comm.am_i_member = false;
                        comm.am_i_admin = false;
                        comm.am_i_master = false;
                        comm.joinStatus = null;
                    } catch (e) {
                        alert(e.message || 'Failed to leave community');
                    }
                };

                const loadCommunityMembers = async () => {
                    if (!viewedCommunity.value) return;
                    try {
                        communityMembers.value = await api(`/api/communities/${viewedCommunity.value.id}/members`);
                    } catch (e) {
                        console.error('Failed to load members:', e);
                        communityMembers.value = [];
                    }
                };

                const loadCommunityRequests = async () => {
                    if (!viewedCommunity.value) return;
                    try {
                        communityRequests.value = await api(`/api/communities/${viewedCommunity.value.id}/requests`);
                    } catch (e) {
                        console.error('Failed to load requests:', e);
                        communityRequests.value = [];
                    }
                };

                // FIXED: Approve using POST /api/communities/approve with correct payload
                const approveCommunityRequest = async (userId) => {
                    try {
                        await api('/api/communities/approve', {
                            method: 'POST',
                            body: JSON.stringify({
                                community_id: viewedCommunity.value.id,
                                user_id: userId,
                                admin_id: currentUser.value.id
                            })
                        });
                        await loadCommunityRequests();
                        await loadCommunityMembers();
                        showToast(t('MSG_REQ_ACCEPTED') || 'Accepted!');
                    } catch (e) {
                        alert(e.message || 'Failed to approve request');
                    }
                };

                const respondCommunityRequest = async (userId, action) => {
                    try {
                        await api('/api/communities/respond_request', {
                            method: 'POST',
                            body: JSON.stringify({
                                community_id: viewedCommunity.value.id,
                                user_id: userId,
                                action: action
                            })
                        });
                        await loadCommunityRequests();
                        if (action === 'accept') await loadCommunityMembers();
                        showToast(action === 'accept' ? (t('MSG_REQ_ACCEPTED') || 'Accepted!') : (t('MSG_REQ_REJECTED') || 'Rejected'));
                    } catch (e) {
                        alert(e.message || 'Failed to process request');
                    }
                };

                const promoteToAdmin = async (userId) => {
                    try {
                        await api('/api/communities/role', {
                            method: 'POST',
                            body: JSON.stringify({
                                community_id: viewedCommunity.value.id,
                                target_id: userId,
                                new_role: 2 // Admin
                            })
                        });
                        await loadCommunityMembers();
                        showToast(t('MSG_ROLE_UPDATED') || 'Role updated!');
                    } catch (e) {
                        alert(e.message || 'Failed to promote');
                    }
                };

                const changeMemberRole = async (userId, newRole) => {
                    try {
                        await api('/api/communities/role', {
                            method: 'POST',
                            body: JSON.stringify({
                                community_id: viewedCommunity.value.id,
                                target_id: userId,
                                new_role: parseInt(newRole)
                            })
                        });
                        await loadCommunityMembers();
                        showToast(t('MSG_ROLE_UPDATED') || 'Role updated!');
                    } catch (e) {
                        alert(e.message || 'Failed to change role');
                    }
                };

                const removeMember = async (userId) => {
                    if (!confirm(t('UI_CONFIRM_REMOVE') || 'Remove this member?')) return;
                    try {
                        await api('/api/communities/remove_member', {
                            method: 'POST',
                            body: JSON.stringify({
                                community_id: viewedCommunity.value.id,
                                admin_id: currentUser.value.id,
                                target_id: userId
                            })
                        });
                        await loadCommunityMembers();
                        showToast(t('MSG_MEMBER_REMOVED') || 'Member removed');
                    } catch (e) {
                        alert(e.message || 'Failed to remove member');
                    }
                };

                const createCommunityPost = async () => {
                    if (!newCommunityPost.content.trim() || !viewedCommunity.value || newCommunityPost.content.length > 300) return;
                    try {
                        const payload = {
                            content: newCommunityPost.content,
                            community_id: viewedCommunity.value.id
                        };
                        if (newCommunityPost.imageBase64) {
                            payload.media_base64 = newCommunityPost.imageBase64;
                        }
                        await api('/api/posts', {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });
                        newCommunityPost.content = '';
                        newCommunityPost.imageBase64 = '';
                        newCommunityPost.imagePreview = '';
                        communityPosts.value = await api(`/api/communities/${viewedCommunity.value.id}/posts?viewer=${currentUser.value.id}`);
                    } catch (e) {
                        alert(e.message || 'Failed to create post');
                    }
                };

                const saveCommunity = async () => {
                    if (!viewedCommunity.value) return;
                    try {
                        await api(`/api/communities/${viewedCommunity.value.id}`, {
                            method: 'PUT',
                            body: JSON.stringify({
                                description: editCommunityForm.description,
                                is_private: editCommunityForm.is_private
                            })
                        });
                        viewedCommunity.value.description = editCommunityForm.description;
                        viewedCommunity.value.is_private = editCommunityForm.is_private;
                        showEditCommunityModal.value = false;
                        showToast(t('MSG_SAVED') || 'Saved!');
                    } catch (e) {
                        alert(e.message || 'Failed to save');
                    }
                };

                // --- FRIENDS ---
                const loadFriends = async () => {
                    try {
                        friends.value = await api('/api/friends');
                    } catch (e) {
                        console.error('Failed to load friends:', e);
                        friends.value = [];
                    }
                };

                const loadPendingRequests = async () => {
                    try {
                        pendingRequests.value = await api('/api/friends/pending');
                    } catch (e) {
                        console.error('Failed to load pending requests:', e);
                        pendingRequests.value = [];
                    }
                };

                const searchUsers = async () => {
                    if (!searchQuery.value.trim()) return;
                    searchPerformed.value = true;
                    try {
                        searchResults.value = await api(`/api/users/search?q=${encodeURIComponent(searchQuery.value)}`);
                    } catch (e) {
                        console.error('Failed to search:', e);
                        searchResults.value = [];
                    }
                };

                const sendFriendRequest = async (toId) => {
                    try {
                        await api('/api/friends/request', {
                            method: 'POST',
                            body: JSON.stringify({ to_id: toId })
                        });
                        showToast(t('MSG_REQ_SENT') || 'Request sent!');
                        if (viewedProfile.value && viewedProfile.value.id === toId) {
                            viewedProfile.value.friend_status = 'pending_sent';
                        }
                    } catch (e) {
                        alert(e.message || 'Failed to send request');
                    }
                };

                const respondFriendRequest = async (requesterId, action) => {
                    try {
                        await api('/api/friends/respond', {
                            method: 'POST',
                            body: JSON.stringify({ requester_id: requesterId, action: action })
                        });
                        await loadPendingRequests();
                        if (action === 'accept') await loadFriends();
                        showToast(action === 'accept' ? (t('MSG_FRIEND_ADDED') || 'Friend added!') : (t('MSG_REQ_REJECTED') || 'Request rejected'));
                        if (viewedProfile.value && viewedProfile.value.id === requesterId) {
                            viewedProfile.value.friend_status = action === 'accept' ? 'friend' : 'none';
                        }
                    } catch (e) {
                        alert(e.message || 'Failed to process request');
                    }
                };

                const removeFriend = async (friendId) => {
                    if (!confirm(t('UI_CONFIRM_REMOVE_FRIEND') || 'Remove this friend?')) return;
                    try {
                        await api('/api/friends/respond', {
                            method: 'POST',
                            body: JSON.stringify({ requester_id: friendId, action: 'reject' })
                        });
                        await loadFriends();
                        showToast(t('MSG_FRIEND_REMOVED') || 'Friend removed');
                        if (viewedProfile.value && viewedProfile.value.id === friendId) {
                            viewedProfile.value.friend_status = 'none';
                        }
                    } catch (e) {
                        alert(e.message || 'Failed to remove friend');
                    }
                };

                // --- PROFILE EDIT ---
                const handleAvatarUpload = async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        editProfileForm.avatarBase64 = await fileToBase64(file);
                        editProfileForm.avatarPreview = editProfileForm.avatarBase64;
                    }
                };

                const handleCoverUpload = async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        editProfileForm.coverBase64 = await fileToBase64(file);
                        editProfileForm.coverPreview = editProfileForm.coverBase64;
                    }
                };

                const saveProfile = async () => {
                    try {
                        const payload = { bio: editProfileForm.bio, is_private: editProfileForm.is_private };
                        if (editProfileForm.email) payload.email = editProfileForm.email;
                        if (editProfileForm.avatarBase64) payload.avatar_base64 = editProfileForm.avatarBase64;
                        if (editProfileForm.coverBase64) payload.cover_base64 = editProfileForm.coverBase64;
                        
                        await api('/api/profile', {
                            method: 'PUT',
                            body: JSON.stringify(payload)
                        });
                        
                        // Update currentUser with new data
                        currentUser.value.bio = editProfileForm.bio;
                        currentUser.value.is_private = editProfileForm.is_private;
                        if (editProfileForm.avatarPreview) currentUser.value.avatar_url = editProfileForm.avatarPreview;
                        if (editProfileForm.coverPreview) currentUser.value.cover_url = editProfileForm.coverPreview;
                        
                        // Save to localStorage
                        localStorage.setItem('user', JSON.stringify(currentUser.value));
                        
                        showEditProfileModal.value = false;
                        showToast(t('MSG_PROFILE_UPDATED') || 'Profile updated!');
                        
                        // Refresh profile view if viewing self
                        if (viewedProfile.value && viewedProfile.value.id === currentUser.value.id) {
                            viewedProfile.value.bio = editProfileForm.bio;
                            if (editProfileForm.avatarPreview) viewedProfile.value.avatar_url = editProfileForm.avatarPreview;
                            if (editProfileForm.coverPreview) viewedProfile.value.cover_url = editProfileForm.coverPreview;
                        }
                        
                        // Clear form
                        editProfileForm.avatarBase64 = '';
                        editProfileForm.coverBase64 = '';
                        editProfileForm.avatarPreview = '';
                        editProfileForm.coverPreview = '';
                    } catch (e) {
                        alert(e.message || 'Failed to save profile');
                    }
                };

                const deleteAccount = async () => {
                    if (!confirm(t('UI_CONFIRM_DELETE') || 'Are you sure you want to delete your account? This cannot be undone!')) return;
                    if (!confirm('This is permanent. Type OK to confirm')) return;
                    try {
                        await api('/api/user', { method: 'DELETE' });
                        showToast(t('MSG_USER_DELETED') || 'Account deleted');
                        logout();
                    } catch (e) {
                        alert(e.message || 'Failed to delete account');
                    }
                };

                // --- NOTIFICATIONS ---
                const loadNotifications = async () => {
                    loading.value = true;
                    try {
                        const data = await api('/api/notifications');
                        notifications.value = Array.isArray(data) ? data : [];
                    } catch (e) {
                        console.error('Failed to load notifications:', e);
                        notifications.value = [];
                    } finally {
                        loading.value = false;
                    }
                };

                const markAllRead = async () => {
                    try {
                        await api('/api/notifications/read', { method: 'POST' });
                        notifications.value.forEach(n => n.is_read = true);
                    } catch (e) {
                        console.error('Failed to mark as read:', e);
                    }
                };

                const handleNotificationClick = (notif) => {
                    // Mark as read
                    notif.is_read = true;
                    
                    // Navigate based on notification type
                    if (notif.post_id) {
                        goToFeed();
                    } else if (notif.actor_id) {
                        viewProfile(notif.actor_id);
                    }
                };

                const startNotificationPolling = () => {
                    lastUnreadCount = 0;
                    pollInterval = setInterval(async () => {
                        try {
                            const data = await api('/api/notifications');
                            if (Array.isArray(data)) {
                                const newUnread = data.filter(n => !n.is_read).length;
                                if (newUnread > lastUnreadCount && lastUnreadCount > 0) {
                                    showToast(t('MSG_NEW_NOTIF') || 'You have new notifications!');
                                }
                                lastUnreadCount = newUnread;
                                notifications.value = data;
                            }
                        } catch (e) {
                            // Handle gracefully if API returns error or nothing
                        }
                    }, 10000);
                };

                const stopNotificationPolling = () => {
                    if (pollInterval) {
                        clearInterval(pollInterval);
                        pollInterval = null;
                    }
                };

                // --- REPORTS (ADMIN) ---
                const loadReports = async () => {
                    try {
                        reports.value = await api('/api/admin/reports');
                    } catch (e) {
                        console.error('Failed to load reports:', e);
                        reports.value = [];
                    }
                };

                const resolveReport = async (reportId, status) => {
                    try {
                        await api('/api/admin/reports/resolve', {
                            method: 'POST',
                            body: JSON.stringify({ report_id: reportId, status: status })
                        });
                        await loadReports();
                        showToast(t('MSG_REPORT_RESOLVED') || 'Report resolved!');
                    } catch (e) {
                        alert(e.message || 'Failed to resolve report');
                    }
                };

                // --- REPORTS ---
                const openReportModal = (type, targetId) => {
                    const typeMap = { 'user': 1, 'post': 2, 'comment': 3 };
                    reportForm.target_id = targetId;
                    reportForm.type = typeMap[type] || 2;
                    reportForm.category = 1;
                    reportForm.reason = '';
                    showReportModal.value = true;
                };

                const submitReport = async () => {
                    if (!reportForm.reason.trim()) return;
                    try {
                        await api('/api/reports', {
                            method: 'POST',
                            body: JSON.stringify({
                                target_id: reportForm.target_id,
                                type: reportForm.type,
                                category: parseInt(reportForm.category),
                                reason: reportForm.reason
                            })
                        });
                        showReportModal.value = false;
                        showToast(t('MSG_REPORT_CREATED') || 'Report submitted!');
                    } catch (e) {
                        alert(e.message || 'Failed to submit report');
                    }
                };

                // --- INIT ---
                onMounted(async () => {
                    await loadTranslations();
                    await loadStates();
                    const savedLang = localStorage.getItem('user_lang');
                    const initialLang = savedLang !== null ? parseInt(savedLang) : 1; 
                    currentLang.value = initialLang;
                    await changeLanguage();
                    if (checkAuth()) {
                        loadFeed();
                        startNotificationPolling();
                    }
                });

                onUnmounted(() => {
                    stopNotificationPolling();
                });

                return {
                    // State
                    translations,
                    isLoggedIn,
                    isRegistering,
                    loading,
                    currentView,
                    currentUser,
                    loginForm,
                    signupForm,
                    authError,
                    authSuccess,
                    showSignupModal,
                    signupUserId,
                    posts,
                    communities,
                    notifications,
                    unreadCount,
                    newPost,
                    newCommunity,
                    showReportModal,
                    reportForm,
                    API_BASE,
                    serverStates,
                    serverCities,
                    currentLang,
                    toast,
                    searchPerformed,

                    // Profile
                    viewedProfile,
                    profilePosts,
                    profileLoading,
                    showEditProfileModal,
                    editProfileForm,

                    // Community
                    viewedCommunity,
                    communityPosts,
                    communityMembers,
                    communityRequests,
                    communityLoading,
                    communitySubView,
                    newCommunityPost,
                    showEditCommunityModal,
                    editCommunityForm,

                    // Friends
                    friends,
                    pendingRequests,
                    searchResults,
                    searchQuery,
                    friendsSubView,

                    // Admin
                    reports,

                    // Methods
                    t,
                    login,
                    signup,
                    logout,
                    goToFeed,
                    goBack,
                    viewProfile,
                    viewCommunity,
                    loadFeed,
                    createPost,
                    deletePost,
                    deleteProfilePost,
                    toggleLike,
                    toggleProfilePostLike,
                    toggleCommunityPostLike,
                    toggleComments,
                    buildCommentTree,
                    setReplyTo,
                    cancelReply,
                    submitComment,
                    toggleCommentLike,
                    deleteComment,
                    loadCommunities,
                    createCommunity,
                    joinCommunity,
                    leaveCommunity,
                    joinCommunityDirect,
                    leaveCommunityDirect,
                    loadCommunityMembers,
                    loadCommunityRequests,
                    approveCommunityRequest,
                    respondCommunityRequest,
                    promoteToAdmin,
                    changeMemberRole,
                    removeMember,
                    createCommunityPost,
                    saveCommunity,
                    loadFriends,
                    loadPendingRequests,
                    searchUsers,
                    sendFriendRequest,
                    respondFriendRequest,
                    removeFriend,
                    saveProfile,
                    deleteAccount,
                    loadNotifications,
                    markAllRead,
                    handleNotificationClick,
                    loadReports,
                    resolveReport,
                    openReportModal,
                    submitReport,
                    loadCities,
                    changeLanguage,
                    formatJoinDate,
                    handlePostImage,
                    clearPostImage,
                    handleCommunityPostImage,
                    clearCommunityPostImage,
                    handleAvatarUpload,
                    handleCoverUpload,
                    openEditProfileModal
                };
            }
        });

        // Register CommentItem globally for recursion
        app.component('comment-item', {
            name: 'CommentItem',
            props: ['comment', 'post', 'currentUser', 'depth', 't'],
            emits: ['reply', 'like', 'delete', 'report', 'viewProfile'],
            template: `
                <div class="comment" :class="'depth-' + Math.min(depth, 3)">
                    <div class="comment-header">
                        <span class="comment-author" @click="$emit('viewProfile', comment.author_id)">{{ comment.author_name || 'Unknown' }}</span>
                        <span style="color:#666;">{{ comment.created_at }}</span>
                    </div>
                    <div>{{ comment.content }}</div>
                    <div class="comment-actions">
                        <button @click="$emit('like', comment)" :class="{ liked: comment.liked_by_me }">
                            &#9829; {{ comment.likes || 0 }}
                        </button>
                        <button @click="$emit('reply', comment)">{{ t('UI_BTN_REPLY') }}</button>
                        <button v-if="comment.author_id === currentUser.id || post.author_id === currentUser.id" class="btn-danger" @click="$emit('delete', comment)">
                            {{ t('UI_BTN_DEL_SHORT') }}
                        </button>
                        <button @click="$emit('report', comment.id)">{{ t('UI_BTN_REPORT') }}</button>
                    </div>
                    <div v-if="comment.replies && comment.replies.length > 0" style="margin-top:10px;">
                        <comment-item 
                            v-for="reply in comment.replies" 
                            :key="reply.id"
                            :comment="reply" 
                            :post="post" 
                            :current-user="currentUser"
                            :depth="depth + 1"
                            :t="t"
                            @reply="$emit('reply', $event)"
                            @like="$emit('like', $event)"
                            @delete="$emit('delete', $event)"
                            @report="$emit('report', $event)"
                            @view-profile="$emit('viewProfile', $event)"
                        ></comment-item>
                    </div>
                </div>
            `
        });

        app.mount('#app');
    </script>
</body>
</html>
