<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CM Industries - Rede Social</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 900: '#0d1117', 800: '#161b22', 700: '#21262d', 600: '#30363d' },
                        neon: { green: '#238636', lime: '#3fb950', cyan: '#58a6ff' }
                    },
                    fontFamily: { mono: ['JetBrains Mono', 'monospace'] }
                }
            }
        }
    </script>
    <style>
        * { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0d1117; }
        ::-webkit-scrollbar-thumb { background: #238636; border-radius: 4px; }
        .glow { box-shadow: 0 0 15px rgba(35, 134, 54, 0.3); }
        .glow-text { text-shadow: 0 0 10px rgba(35, 134, 54, 0.5); }
        .terminal-cursor::after { content: '‚ñà'; animation: blink 1s infinite; }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
        .toast-exit { animation: slideOut 0.3s ease-in forwards; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        /* Like animation */
        @keyframes heart-burst {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); color: #ff0055; }
            100% { transform: scale(1); color: #3fb950; } 
        }
        .animate-like {
            animation: heart-burst 0.3s ease-in-out;
        }

        /* Avatar frame */
        .avatar-frame { border: 3px solid #58a6ff; }
        /* Friend highlight */
        .friend-highlight { border-color: #3fb950 !important; }
    </style>
</head>
<body class="bg-dark-900 text-gray-300 min-h-screen">
    
    <!-- Auth Screen -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-neon-green glow-text terminal-cursor">CM_INDUSTRIES</h1>
                <p class="text-gray-500 mt-2" data-i18n="UI_SUBTITLE">&gt; Sistema de Rede Social v2.0</p>
            </div>
            
            <div class="bg-dark-800 border border-dark-600 rounded-lg p-6 glow">
                <div class="flex mb-6 border-b border-dark-600">
                    <button id="login-tab" onclick="switchAuthTab('login')" class="flex-1 py-3 text-neon-green border-b-2 border-neon-green" data-i18n="UI_TAB_LOGIN">LOGIN</button>
                    <button id="signup-tab" onclick="switchAuthTab('signup')" class="flex-1 py-3 text-gray-500 border-b-2 border-transparent hover:text-gray-300" data-i18n="UI_TAB_SIGNUP">CADASTRO</button>
                </div>
                
                <!-- Login Form -->
                <form id="login-form" onsubmit="handleLogin(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs text-neon-green mb-1" data-i18n="UI_LABEL_IDENTIFIER">&gt; IDENTIFICADOR</label>
                        <input type="text" id="login-identifier" required class="w-full bg-dark-900 border border-dark-600 rounded px-4 py-2 focus:border-neon-green focus:outline-none" data-i18n-placeholder="UI_PLACEHOLDER_IDENTIFIER">
                    </div>
                    <div>
                        <label class="block text-xs text-neon-green mb-1" data-i18n="UI_LABEL_PASSWORD">&gt; SENHA</label>
                        <input type="password" id="login-password" required class="w-full bg-dark-900 border border-dark-600 rounded px-4 py-2 focus:border-neon-green focus:outline-none" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button type="submit" class="w-full bg-neon-green text-dark-900 font-bold py-3 rounded hover:bg-neon-lime transition-colors" data-i18n="UI_BTN_LOGIN">&gt; ACESSAR_SISTEMA</button>
                </form>
                
                <!-- Signup Form -->
                <form id="signup-form" onsubmit="handleSignup(event)" class="space-y-4 hidden">
                    <div>
                        <label class="block text-xs text-neon-green mb-1" data-i18n="UI_LABEL_USERNAME">&gt; USERNAME</label>
                        <input type="text" id="signup-username" required class="w-full bg-dark-900 border border-dark-600 rounded px-4 py-2 focus:border-neon-green focus:outline-none" data-i18n-placeholder="UI_PLACEHOLDER_USERNAME">
                    </div>
                    <div>
                        <label class="block text-xs text-neon-green mb-1" data-i18n="UI_LABEL_EMAIL">&gt; EMAIL</label>
                        <input type="email" id="signup-email" required class="w-full bg-dark-900 border border-dark-600 rounded px-4 py-2 focus:border-neon-green focus:outline-none" data-i18n-placeholder="UI_PLACEHOLDER_EMAIL">
                    </div>
                    <div>
                        <label class="block text-xs text-neon-green mb-1" data-i18n="UI_LABEL_PASSWORD">&gt; SENHA</label>
                        <input type="password" id="signup-password" required class="w-full bg-dark-900 border border-dark-600 rounded px-4 py-2 focus:border-neon-green focus:outline-none" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-neon-green mb-1" data-i18n="UI_LABEL_STATE">&gt; ESTADO</label>
                            <select id="signup-state" onchange="loadCities()" class="w-full bg-dark-900 border border-dark-600 rounded px-4 py-2 focus:border-neon-green focus:outline-none">
                                <option value="" data-i18n="UI_SELECT_DEFAULT">Selecione...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-neon-green mb-1" data-i18n="UI_LABEL_CITY">&gt; CIDADE</label>
                            <select id="signup-city" class="w-full bg-dark-900 border border-dark-600 rounded px-4 py-2 focus:border-neon-green focus:outline-none">
                                <option value="" data-i18n="UI_SELECT_DEFAULT">Selecione...</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-neon-green text-dark-900 font-bold py-3 rounded hover:bg-neon-lime transition-colors" data-i18n="UI_BTN_SIGNUP">&gt; CRIAR_CONTA</button>
                </form>
                
                <div id="auth-message" class="mt-4 text-center text-sm hidden"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal de ID apos cadastro -->
    <div id="signup-success-modal" class="modal hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
        <div class="bg-dark-800 border border-neon-green rounded-lg p-8 w-full max-w-md glow text-center">
            <div class="text-6xl mb-4">üéâ</div>
            <h3 class="text-2xl font-bold text-neon-green mb-4" data-i18n="UI_SIGNUP_SUCCESS">&gt; CONTA_CRIADA!</h3>
            <p class="text-gray-300 mb-4" data-i18n="UI_SIGNUP_ID_MSG">Seu ID de acesso e:</p>
            <div class="bg-dark-900 border border-neon-cyan rounded-lg p-4 mb-6">
                <span id="signup-user-id" class="text-4xl font-bold text-neon-cyan"></span>
            </div>
            <p class="text-yellow-400 text-sm mb-6" data-i18n="UI_SIGNUP_SAVE_ID">‚ö†Ô∏è ANOTE ESTE NUMERO! Voce pode usar ele ou seu email para fazer login.</p>
            <button onclick="closeSignupModal()" class="w-full bg-neon-green text-dark-900 font-bold py-3 rounded hover:bg-neon-lime transition-colors" data-i18n="UI_BTN_OK_NOTED">&gt; OK, ANOTEI!</button>
        </div>
    </div>
    
    <!-- Main App -->
    <div id="main-app" class="hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed left-0 top-0 h-full w-64 bg-dark-800 border-r border-dark-600 z-40 transform -translate-x-full lg:translate-x-0 transition-transform">
            <div class="p-4 border-b border-dark-600">
                <h1 class="text-xl font-bold text-neon-green glow-text">CM_INDUSTRIES</h1>
                <p class="text-xs text-gray-500">v2.0 :: <span id="user-display"></span></p>
            </div>
            
            <nav class="p-4 space-y-2">
                <button onclick="navigate('feed')" class="nav-btn w-full text-left px-4 py-3 rounded border border-transparent hover:border-neon-green hover:bg-dark-700 transition-colors flex items-center gap-3" data-page="feed">
                    <span class="text-neon-green">&gt;</span> <span data-i18n="UI_NAV_FEED">Feed</span>
                </button>
                <button onclick="navigate('communities')" class="nav-btn w-full text-left px-4 py-3 rounded border border-transparent hover:border-neon-green hover:bg-dark-700 transition-colors flex items-center gap-3" data-page="communities">
                    <span class="text-neon-green">&gt;</span> <span data-i18n="UI_NAV_COMMUNITIES">Comunidades</span>
                </button>
                <button onclick="navigate('friends')" class="nav-btn w-full text-left px-4 py-3 rounded border border-transparent hover:border-neon-green hover:bg-dark-700 transition-colors flex items-center gap-3" data-page="friends">
                    <span class="text-neon-green">&gt;</span> <span data-i18n="UI_NAV_FRIENDS">Amigos</span>
                </button>
                <button onclick="navigate('notifications')" class="nav-btn w-full text-left px-4 py-3 rounded border border-transparent hover:border-neon-green hover:bg-dark-700 transition-colors flex items-center gap-3" data-page="notifications">
                    <span class="text-neon-green">&gt;</span> <span data-i18n="UI_NAV_NOTIFICATIONS">Notificacoes</span>
                    <span id="notif-badge" class="hidden bg-red-500 text-white text-xs px-2 py-0.5 rounded-full"></span>
                </button>
                <button onclick="navigate('settings')" class="nav-btn w-full text-left px-4 py-3 rounded border border-transparent hover:border-neon-green hover:bg-dark-700 transition-colors flex items-center gap-3" data-page="settings">
                    <span class="text-neon-green">&gt;</span> <span data-i18n="UI_NAV_SETTINGS">Configuracoes</span>
                </button>
            </nav>
            
            <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-dark-600">
                <button onclick="logout()" class="w-full text-left px-4 py-2 text-red-400 hover:text-red-300 hover:bg-dark-700 rounded transition-colors" data-i18n="UI_NAV_LOGOUT">
                    &gt; LOGOUT
                </button>
            </div>
        </aside>
        
        <!-- Mobile Menu Toggle -->
        <button id="mobile-menu-btn" onclick="toggleSidebar()" class="lg:hidden fixed top-4 left-4 z-50 bg-dark-800 border border-dark-600 p-2 rounded">
            <svg class="w-6 h-6 text-neon-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>
        
        <!-- Main Content -->
        <main class="lg:ml-64 min-h-screen">
            <!-- Feed Page -->
            <div id="page-feed" class="page p-6">
                <div class="max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-neon-green mb-6 glow-text" data-i18n="UI_TITLE_FEED">&gt; FEED_PRINCIPAL</h2>
                    
                    <!-- Create Post -->
                    <div class="bg-dark-800 border border-dark-600 rounded-lg p-4 mb-6 glow">
                        <textarea id="post-content" class="w-full bg-dark-900 border border-dark-600 rounded p-3 resize-none h-24 focus:border-neon-green focus:outline-none" data-i18n-placeholder="UI_PLACEHOLDER_POST"></textarea>
                        <div class="flex items-center justify-between mt-3">
                            <div class="flex items-center gap-2">
                                <input type="file" id="post-media" accept="image/*,video/*" class="hidden" onchange="previewMedia(event)">
                                <button onclick="document.getElementById('post-media').click()" class="px-3 py-1 border border-dark-600 rounded text-sm hover:border-neon-green transition-colors" data-i18n="UI_BTN_ADD_MEDIA">+ Midia</button>
                                <span id="media-preview-name" class="text-xs text-gray-500"></span>
                            </div>
                            <button onclick="createPost()" class="bg-neon-green text-dark-900 px-4 py-2 rounded font-bold hover:bg-neon-lime transition-colors" data-i18n="UI_BTN_PUBLISH">&gt; PUBLICAR</button>
                        </div>
                    </div>
                    
                    <div id="feed-posts" class="space-y-4"></div>
                </div>
            </div>
            
            <!-- Communities Page -->
            <div id="page-communities" class="page hidden p-6">
                <div class="max-w-4xl mx-auto">
                    <div id="community-header" class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-4">
                            <button id="back-to-communities" onclick="backToCommunities()" class="hidden text-neon-cyan hover:text-neon-green transition-colors" data-i18n="UI_BTN_BACK">&lt; Voltar</button>
                            <h2 id="communities-title" class="text-2xl font-bold text-neon-green glow-text" data-i18n="UI_TITLE_COMMUNITIES">&gt; COMUNIDADES</h2>
                        </div>
                        <button id="create-community-btn" onclick="openModal('create-community-modal')" class="bg-neon-green text-dark-900 px-4 py-2 rounded font-bold hover:bg-neon-lime transition-colors" data-i18n="UI_BTN_CREATE_COMMUNITY">&gt; CRIAR_COMUNIDADE</button>
                    </div>
                    
                    <div id="communities-list" class="grid gap-4 md:grid-cols-2"></div>
                    
                    <!-- Community Dashboard View -->
                    <div id="community-dashboard" class="hidden">
                        <!-- Cover & Header -->
                        <div id="community-cover" class="relative h-48 rounded-t-lg bg-cover bg-center" style="background-image: url('https://picsum.photos/seed/cyber/800/200');">
                            <div class="absolute inset-0 bg-gradient-to-t from-dark-900 to-transparent"></div>
                        </div>
                        <div class="bg-dark-800 border border-dark-600 border-t-0 rounded-b-lg p-6 mb-6">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                <div>
                                    <h2 id="community-dash-name" class="text-2xl font-bold text-neon-green glow-text"></h2>
                                    <p id="community-dash-desc" class="text-gray-400 mt-1"></p>
                                    <p id="community-dash-location" class="text-gray-600 text-sm mt-1"></p>
                                    <p id="community-dash-members" class="text-neon-cyan text-sm mt-2"></p>
                                </div>
                                <div id="community-action-btn" class="flex-shrink-0"></div>
                            </div>
                        </div>
                        
                        <!-- Community Tabs -->
                        <div class="flex border-b border-dark-600 mb-6">
                            <button id="comm-tab-feed" onclick="switchCommunityTab('feed')" class="flex-1 py-3 text-neon-cyan border-b-2 border-neon-cyan text-center" data-i18n="UI_TAB_FEED">[FEED]</button>
                            <button id="comm-tab-members" onclick="switchCommunityTab('members')" class="flex-1 py-3 text-gray-500 border-b-2 border-transparent hover:text-gray-300 text-center" data-i18n="UI_TAB_MEMBERS">[MEMBROS]</button>
                            <button id="comm-tab-admin" onclick="switchCommunityTab('admin')" class="flex-1 py-3 text-gray-500 border-b-2 border-transparent hover:text-gray-300 text-center hidden" data-i18n="UI_TAB_ADMIN">[ADMIN]</button>
                        </div>
                        
                        <!-- Feed Tab -->
                        <div id="community-tab-feed">
                            <div id="community-create-post" class="bg-dark-800 border border-dark-600 rounded-lg p-4 mb-6 glow hidden">
                                <textarea id="community-post-content" class="w-full bg-dark-900 border border-dark-600 rounded p-3 resize-none h-20 focus:border-neon-green focus:outline-none" data-i18n-placeholder="UI_PLACEHOLDER_POST_COMMUNITY"></textarea>
                                <div class="flex items-center justify-between mt-3">
                                    <div class="flex items-center gap-2">
                                        <input type="file" id="community-post-media" accept="image/*,video/*" class="hidden" onchange="previewCommunityMedia(event)">
                                        <button onclick="document.getElementById('community-post-media').click()" class="px-3 py-1 border border-dark-600 rounded text-sm hover:border-neon-green transition-colors" data-i18n="UI_BTN_ADD_MEDIA">+ Midia</button>
                                        <span id="community-media-preview-name" class="text-xs text-gray-500"></span>
                                    </div>
                                    <button onclick="createCommunityPost()" class="bg-neon-green text-dark-900 px-4 py-2 rounded font-bold hover:bg-neon-lime transition-colors" data-i18n="UI_BTN_PUBLISH">&gt; PUBLICAR</button>
                                </div>
                            </div>
                            <div id="community-posts" class="space-y-4"></div>
                        </div>
                        
                        <!-- Members Tab -->
                        <div id="community-tab-members" class="hidden">
                            <div id="community-members-list" class="space-y-2"></div>
                        </div>
                        
                        <!-- Admin Tab -->
                        <div id="community-tab-admin" class="hidden">
                            <div class="bg-dark-800 border border-dark-600 rounded-lg p-4 mb-4">
                                <h3 class="text-lg font-bold text-neon-green mb-4" data-i18n="UI_TITLE_PENDING_REQUESTS">&gt; Solicitacoes Pendentes</h3>
                                <div id="community-pending-requests" class="space-y-2"></div>
                            </div>
                            <div class="bg-dark-800 border border-red-600/30 rounded-lg p-4">
                                <h3 class="text-lg font-bold text-red-400 mb-4" data-i18n="UI_TITLE_DANGER_ZONE">&gt; Zona Perigosa</h3>
                                <button onclick="leaveCommunity()" class="bg-red-600/20 border border-red-600 text-red-400 px-4 py-2 rounded font-bold hover:bg-red-600 hover:text-white transition-colors" data-i18n="UI_BTN_LEAVE_COMMUNITY">&gt; SAIR_DA_COMUNIDADE</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Friends Page -->
            <div id="page-friends" class="page hidden p-6">
                <div class="max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-neon-green mb-6 glow-text" data-i18n="UI_TITLE_SEARCH">&gt; BUSCAR_USUARIOS</h2>
                    
                    <div class="bg-dark-800 border border-dark-600 rounded-lg p-4 mb-6">
                        <div class="flex gap-2">
                            <input type="text" id="search-users" class="flex-1 bg-dark-900 border border-dark-600 rounded px-4 py-2 focus:border-neon-green focus:outline-none" data-i18n-placeholder="UI_PLACEHOLDER_SEARCH" onkeyup="debounceSearch(event)">
                            <button onclick="searchUsers()" class="bg-neon-green text-dark-900 px-4 py-2 rounded font-bold hover:bg-neon-lime transition-colors" data-i18n="UI_BTN_SEARCH">&gt; BUSCAR</button>
                        </div>
                    </div>
                    
                    <div id="search-results" class="space-y-2 mb-8"></div>
                    
                    <div class="flex border-b border-dark-600 mb-4">
                        <button id="friends-tab-pending" onclick="switchFriendsTab('pending')" class="flex-1 py-3 text-neon-cyan border-b-2 border-neon-cyan" data-i18n="UI_TAB_PENDING">&gt; SOLICITACOES_PENDENTES</button>
                        <button id="friends-tab-list" onclick="switchFriendsTab('list')" class="flex-1 py-3 text-gray-500 border-b-2 border-transparent hover:text-gray-300" data-i18n="UI_TAB_FRIENDS">&gt; MEUS_AMIGOS</button>
                    </div>
                    <div id="pending-requests" class="space-y-2"></div>
                    <div id="friends-list" class="space-y-2 hidden"></div>
                </div>
            </div>
            
            <!-- Profile Page (Dynamic) -->
            <div id="page-profile" class="page hidden p-6">
                <div class="max-w-2xl mx-auto">
                    <div id="profile-content"></div>
                    <div id="profile-timeline" class="mt-6 space-y-4"></div>
                </div>
            </div>
            
            <!-- Notifications Page -->
            <div id="page-notifications" class="page hidden p-6">
                <div class="max-w-2xl mx-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-neon-green glow-text" data-i18n="UI_TITLE_NOTIFICATIONS">&gt; NOTIFICACOES</h2>
                        <button onclick="markNotificationsRead()" class="text-sm text-neon-cyan hover:underline" data-i18n="UI_BTN_MARK_READ">Marcar todas como lidas</button>
                    </div>
                    
                    <div class="flex border-b border-dark-600 mb-4">
                        <button id="notif-tab-alerts" onclick="switchNotifTab('alerts')" class="flex-1 py-3 text-neon-cyan border-b-2 border-neon-cyan" data-i18n="UI_TAB_ALERTS">&gt; ALERTAS</button>
                        <button id="notif-tab-requests" onclick="switchNotifTab('requests')" class="flex-1 py-3 text-gray-500 border-b-2 border-transparent hover:text-gray-300" data-i18n="UI_TAB_REQUESTS">&gt; SOLICITACOES</button>
                    </div>
                    
                    <div id="notifications-alerts" class="space-y-2"></div>
                    <div id="notifications-requests" class="space-y-2 hidden"></div>
                </div>
            </div>
            
            <!-- Settings Page -->
            <div id="page-settings" class="page hidden p-6">
                <div class="max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-neon-green mb-6 glow-text" data-i18n="UI_TITLE_SETTINGS">&gt; CONFIGURACOES</h2>
                    
                    <div class="bg-dark-800 border border-dark-600 rounded-lg p-6 space-y-6">
                        <div>
                            <label class="block text-sm text-neon-green mb-2" data-i18n="UI_LABEL_BIO">&gt; BIO</label>
                            <textarea id="settings-bio" class="w-full bg-dark-900 border border-dark-600 rounded p-3 resize-none h-24 focus:border-neon-green focus:outline-none" data-i18n-placeholder="UI_PLACEHOLDER_BIO"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm text-neon-green mb-2" data-i18n="UI_LABEL_EMAIL">&gt; EMAIL</label>
                            <input type="email" id="settings-email" class="w-full bg-dark-900 border border-dark-600 rounded px-4 py-2 focus:border-neon-green focus:outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-sm text-neon-green mb-2" data-i18n="UI_LABEL_BIRTHDATE">&gt; DATA DE NASCIMENTO</label>
                            <input type="date" id="settings-birthdate" class="w-full bg-dark-900 border border-dark-600 rounded px-4 py-2 focus:border-neon-green focus:outline-none">
                        </div>
                        
                        <div class="flex items-center gap-3">
                            <input type="checkbox" id="settings-private" class="w-5 h-5 bg-dark-900 border border-dark-600 rounded focus:ring-neon-green">
                            <label for="settings-private" class="text-sm text-gray-300" data-i18n="UI_LABEL_PRIVATE">Perfil Privado</label>
                        </div>
                        
                        <button onclick="updateProfile()" class="bg-neon-green text-dark-900 px-6 py-2 rounded font-bold hover:bg-neon-lime transition-colors" data-i18n="UI_BTN_SAVE">&gt; SALVAR_ALTERACOES</button>
                        
                        <hr class="border-dark-600">
                        
                        <div class="pt-4">
                            <h3 class="text-red-400 font-bold mb-4" data-i18n="UI_TITLE_DANGER">&gt; ZONA_PERIGOSA</h3>
                            <button onclick="confirmDeleteAccount()" class="bg-red-600 text-white px-6 py-2 rounded font-bold hover:bg-red-500 transition-colors" data-i18n="UI_BTN_DELETE_ACCOUNT">&gt; EXCLUIR_CONTA</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modals -->
    <!-- Create Community Modal -->
    <div id="create-community-modal" class="modal hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="bg-dark-800 border border-dark-600 rounded-lg p-6 w-full max-w-md glow">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-neon-green" data-i18n="UI_TITLE_CREATE_COMMUNITY">&gt; CRIAR_COMUNIDADE</h3>
                <button onclick="closeModal('create-community-modal')" class="text-gray-500 hover:text-white text-2xl">&times;</button>
            </div>
            
            <form onsubmit="createCommunity(event)" class="space-y-4">
                <div>
                    <label class="block text-xs text-neon-green mb-1" data-i18n="UI_LABEL_NAME">&gt; NOME</label>
                    <input type="text" id="community-name" required class="w-full bg-dark-900 border border-dark-600 rounded px-4 py-2 focus:border-neon-green focus:outline-none">
                </div>
                <div>
                    <label class="block text-xs text-neon-green mb-1" data-i18n="UI_LABEL_DESCRIPTION">&gt; DESCRICAO</label>
                    <textarea id="community-description" class="w-full bg-dark-900 border border-dark-600 rounded p-3 resize-none h-20 focus:border-neon-green focus:outline-none"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-neon-green mb-1" data-i18n="UI_LABEL_STATE">&gt; ESTADO</label>
                        <select id="community-state" onchange="loadCommunityCities()" class="w-full bg-dark-900 border border-dark-600 rounded px-4 py-2 focus:border-neon-green focus:outline-none">
                            <option value="">Opcional...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-neon-green mb-1" data-i18n="UI_LABEL_CITY">&gt; CIDADE</label>
                        <select id="community-city" class="w-full bg-dark-900 border border-dark-600 rounded px-4 py-2 focus:border-neon-green focus:outline-none">
                            <option value="">Opcional...</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="w-full bg-neon-green text-dark-900 font-bold py-3 rounded hover:bg-neon-lime transition-colors" data-i18n="UI_BTN_CREATE">&gt; CRIAR</button>
            </form>
        </div>
    </div>
    
    <!-- Report Modal -->
    <div id="report-modal" class="modal hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="bg-dark-800 border border-dark-600 rounded-lg p-6 w-full max-w-md glow">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-red-400" data-i18n="UI_TITLE_REPORT">&gt; DENUNCIAR</h3>
                <button onclick="closeModal('report-modal')" class="text-gray-500 hover:text-white text-2xl">&times;</button>
            </div>
            
            <form onsubmit="submitReport(event)" class="space-y-4">
                <input type="hidden" id="report-target-id">
                <input type="hidden" id="report-type">
                
                <div>
                    <label class="block text-xs text-neon-green mb-1" data-i18n="UI_LABEL_CATEGORY">&gt; CATEGORIA</label>
                    <select id="report-category" required class="w-full bg-dark-900 border border-dark-600 rounded px-4 py-2 focus:border-neon-green focus:outline-none">
                        <option value="1" data-i18n="UI_REPORT_SPAM">Spam</option>
                        <option value="2" data-i18n="UI_REPORT_INAPPROPRIATE">Conteudo Improprio</option>
                        <option value="3" data-i18n="UI_REPORT_HARASSMENT">Assedio</option>
                        <option value="4" data-i18n="UI_REPORT_FAKE">Fake/Golpe</option>
                        <option value="5" data-i18n="UI_REPORT_OTHER">Outro</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs text-neon-green mb-1" data-i18n="UI_LABEL_REASON">&gt; MOTIVO</label>
                    <textarea id="report-reason" required class="w-full bg-dark-900 border border-dark-600 rounded p-3 resize-none h-24 focus:border-neon-green focus:outline-none" data-i18n-placeholder="UI_PLACEHOLDER_REASON"></textarea>
                </div>
                <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 rounded hover:bg-red-500 transition-colors" data-i18n="UI_BTN_SEND_REPORT">&gt; ENVIAR_DENUNCIA</button>
            </form>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"></div>

    <script>
        // ===========================================
        // CONFIGURACAO & ESTADO GLOBAL
        // ===========================================
        const API_BASE = '';
        let authToken = localStorage.getItem('cm_token');
        let currentUser = localStorage.getItem('cm_user');
        let locations = {};
        let translations = {};
        let searchTimeout = null;
        let currentPostMedia = null;
        let currentCommunityPostMedia = null;
        let currentCommunityId = null;
        let currentCommunityData = null;
        let currentCommunityRole = null;
        let loadedCommentsCache = {};

        const DEFAULT_AVATAR = (name) => `https://ui-avatars.com/api/?name=${encodeURIComponent(name || 'User')}&background=0D1117&color=238636`;
        const DEFAULT_COVER = 'https://picsum.photos/seed/cyber/800/200';

        // ===========================================
        // SISTEMA DE TRADUCAO (data-i18n)
        // ===========================================
        async function loadTranslations() {
            try {
                const res = await fetch(`${API_BASE}/api/translations`);
                if (res.ok) {
                    translations = await res.json();
                    applyTranslations();
                }
            } catch (err) {
                console.error('Erro ao carregar traducoes:', err);
            }
        }

        async function openProfileByName(username) {
            try {
                const res = await fetch(`${API_BASE}/api/search?q=${username}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (res.ok) {
                    const users = await res.json();
                    if (users.length > 0) {
                        loadUserProfile(users[0].id); // Abre o primeiro que achar
                    } else {
                        showToast('Usu√°rio n√£o encontrado', 'error');
                    }
                }
            } catch (e) {
                console.error(e);
            }
        }

        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[key]) {
                    el.textContent = translations[key];
                }
            });
            
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[key]) {
                    el.placeholder = translations[key];
                }
            });
        }

        function t(key, fallback = '') {
            return translations[key] || fallback || key;
        }

        // ===========================================
        // INICIALIZACAO
        // ===========================================
        document.addEventListener('DOMContentLoaded', async () => {
            await loadTranslations();
            await loadLocations();
            
            if (authToken && currentUser) {
                showApp();
            } else {
                showAuth();
            }
        });

        function showAuth() {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('user-display').textContent = currentUser;
            navigate('feed');
            loadNotificationsCount();
        }

        // ===========================================
        // AUTENTICACAO
        // ===========================================
        function switchAuthTab(tab) {
            const loginTab = document.getElementById('login-tab');
            const signupTab = document.getElementById('signup-tab');
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');

            if (tab === 'login') {
                loginTab.classList.add('text-neon-green', 'border-neon-green');
                loginTab.classList.remove('text-gray-500', 'border-transparent');
                signupTab.classList.remove('text-neon-green', 'border-neon-green');
                signupTab.classList.add('text-gray-500', 'border-transparent');
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
            } else {
                signupTab.classList.add('text-neon-green', 'border-neon-green');
                signupTab.classList.remove('text-gray-500', 'border-transparent');
                loginTab.classList.remove('text-neon-green', 'border-neon-green');
                loginTab.classList.add('text-gray-500', 'border-transparent');
                signupForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const identifier = document.getElementById('login-identifier').value;
            const password = document.getElementById('login-password').value;

            try {
                const res = await fetch(`${API_BASE}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identifier, password })
                });

                if (res.ok) {
                    const data = await res.json();
                    authToken = data.token;
                    currentUser = data.username;
                    localStorage.setItem('cm_token', authToken);
                    localStorage.setItem('cm_user', currentUser);
                    localStorage.setItem('cm_user_id', data.id);
                    showToast(t('MSG_LOGIN_OK', 'Login realizado!'), 'success');
                    showApp();
                } else {
                    const errorMsg = await getApiMessage(res);
                    showAuthMessage(errorMsg, 'error');
                }
            } catch (err) {
                showAuthMessage(t('ERR_CONNECTION', 'Erro de conexao'), 'error');
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            const username = document.getElementById('signup-username').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const state = document.getElementById('signup-state').value;
            const city = document.getElementById('signup-city').value;

            try {
                const res = await fetch(`${API_BASE}/api/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password, state, city })
                });

                if (res.ok) {
                    const data = await res.json();
                    // Show modal with user ID
                    document.getElementById('signup-user-id').textContent = data.id;
                    document.getElementById('signup-success-modal').classList.remove('hidden');
                } else {
                    const errorMsg = await getApiMessage(res);
                    showAuthMessage(errorMsg, 'error');
                }
            } catch (err) {
                showAuthMessage(t('ERR_CONNECTION', 'Erro de conexao'), 'error');
            }
        }

        function closeSignupModal() {
            document.getElementById('signup-success-modal').classList.add('hidden');
            switchAuthTab('login');
        }

        // LOGOUT REAL - localStorage.clear() + reload
        function logout() {
            localStorage.clear();
            window.location.reload();
        }

        function showAuthMessage(msg, type) {
            const el = document.getElementById('auth-message');
            el.textContent = msg;
            el.classList.remove('hidden', 'text-green-400', 'text-red-400');
            el.classList.add(type === 'success' ? 'text-green-400' : 'text-red-400');
        }

        // ===========================================
        // HELPER: Extrair mensagem da API
        // ===========================================
        async function getApiMessage(res, fallback = 'Erro desconhecido') {
            try {
                const contentType = res.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await res.json();
                    return data.message || fallback;
                } else {
                    const text = await res.text();
                    return text || fallback;
                }
            } catch {
                return fallback;
            }
        }

        function formatJoinDate(dateStr) {
            if (!dateStr) return 'N/A';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
            } catch {
                return dateStr;
            }
        }

        // ===========================================
        // NAVEGACAO
        // ===========================================
        function navigate(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${page}`).classList.remove('hidden');

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('border-neon-green', 'bg-dark-700');
                btn.classList.add('border-transparent');
            });
            const activeBtn = document.querySelector(`.nav-btn[data-page="${page}"]`);
            if (activeBtn) {
                activeBtn.classList.add('border-neon-green', 'bg-dark-700');
                activeBtn.classList.remove('border-transparent');
            }

            switch (page) {
                case 'feed': 
                    currentCommunityId = null;
                    loadFeed(); 
                    break;
                case 'communities': 
                    currentCommunityId = null;
                    backToCommunities();
                    loadCommunities(); 
                    break;
                case 'friends': 
                    switchFriendsTab('pending');
                    break;
                case 'notifications': 
                    switchNotifTab('alerts');
                    break;
            }

            document.getElementById('sidebar').classList.add('-translate-x-full');
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('-translate-x-full');
        }

        // ===========================================
        // FEED & POSTS
        // ===========================================
        async function loadFeed() {
            try {
                const res = await fetch(`${API_BASE}/api/feed`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (res.status === 401) return handleUnauthorized();

                const posts = await res.json();
                renderPosts(posts, 'feed-posts');
            } catch (err) {
                console.error('Erro ao carregar feed:', err);
            }
        }

        function renderPosts(posts, containerId) {
            const container = document.getElementById(containerId);
            
            if (!posts || posts.length === 0) {
                container.innerHTML = `
                    <div class="bg-dark-800 border border-dark-600 rounded-lg p-8 text-center">
                        <p class="text-gray-500">${t('LBL_NO_POSTS', '> Nenhum post encontrado...')}</p>
                    </div>
                `;
                return;
            }
        
            container.innerHTML = posts.map(post => {
                // 1. L√ìGICA (CALCULA TUDO ANTES DO HTML)
                const originLabel = (post.origin && post.origin !== 'Pessoal') 
                    ? `<span class="inline-block bg-neon-cyan/20 text-neon-cyan text-xs px-2 py-1 rounded mb-2">üìç ${escapeHtml(post.origin)}</span>` 
                    : '';

                // L√≥gica do @Link
                let contentHtml = escapeHtml(post.content);
                contentHtml = contentHtml.replace(/@(\w+)/g, '<span class="text-neon-cyan cursor-pointer hover:underline" onclick="openProfileByName(\'$1\')">@$1</span>');

                // 2. O HTML LIMPO (S√ì AS VARI√ÅVEIS)
                return `
                    <div class="bg-dark-800 border border-dark-600 rounded-lg p-4 hover:border-neon-green/50 transition-colors mb-4" data-post-id="${post.id}">
                        ${originLabel}
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <img src="${DEFAULT_AVATAR(post.author || post.author_name)}" alt="" class="w-10 h-10 rounded-full avatar-frame">
                                <div>
                                    <button onclick="openProfile(${post.author_id || 0})" class="text-neon-green font-bold hover:text-neon-lime transition-colors">@${escapeHtml(post.author || post.author_name || 'Unknown')}</button>
                                    ${post.location ? `<span class="text-gray-600 text-xs block">${escapeHtml(post.location)}</span>` : ''}
                                </div>
                            </div>
                            <button onclick="openReportModal(${post.id}, 2)" class="text-gray-500 hover:text-red-400 text-sm" title="Denunciar">[!]</button>
                        </div>
                        
                        <p class="mb-4 whitespace-pre-wrap">${contentHtml}</p>

                        ${renderMedia(post)}
                        
                        <div class="flex items-center gap-4 mt-3 pt-3 border-t border-dark-600">
                            <button onclick="toggleLike(${post.id}, this)" class="flex items-center gap-1 text-sm hover:text-neon-green transition-colors ${post.liked ? 'text-neon-lime' : ''}" id="like-btn-${post.id}">
                                <span class="like-icon">${post.liked ? '[‚ô•]' : '[‚ô°]'}</span> <span class="like-count">${post.likes || post.likes_count || 0}</span>
                            </button>
                            <button onclick="toggleInlineComments(${post.id})" class="flex items-center gap-1 text-sm hover:text-neon-cyan transition-colors">
                                [COMMENTS]
                            </button>
                        </div>
                    </div>`;
            }).join('');
        }

        function renderMedia(post) {
            if (!post.media_url) return '';
            
            const mediaType = post.media_type || 'image';
            const mediaUrl = post.media_url.startsWith('http') ? post.media_url : `${API_BASE}/${post.media_url}`;
            
            if (mediaType === 'video') {
                return `<video src="${mediaUrl}" controls class="w-full max-h-96 rounded object-contain bg-black"></video>`;
            }
            return `<img src="${mediaUrl}" alt="Post media" class="w-full max-h-96 rounded object-contain bg-dark-900" loading="lazy">`;
        }

        function previewMedia(e) {
            const file = e.target.files[0];
            if (file) {
                currentPostMedia = file;
                document.getElementById('media-preview-name').textContent = file.name;
            }
        }

        function previewCommunityMedia(e) {
            const file = e.target.files[0];
            if (file) {
                currentCommunityPostMedia = file;
                document.getElementById('community-media-preview-name').textContent = file.name;
            }
        }

        async function createPost() {
            const content = document.getElementById('post-content').value.trim();
            if (!content) return showToast(t('ERR_EMPTY_POST', 'Digite algo para publicar'), 'error');

            const payload = { content };

            if (currentCommunityId) {
                payload.community_id = currentCommunityId;
            }

            if (currentPostMedia) {
                const base64 = await fileToBase64(currentPostMedia);
                payload.media_base64 = base64;
            }

            try {
                const res = await fetch(`${API_BASE}/api/posts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(payload)
                });

                if (res.status === 401) return handleUnauthorized();

                const msg = await getApiMessage(res, t('MSG_POST_CREATED', 'Post publicado!'));
                
                if (res.ok) {
                    document.getElementById('post-content').value = '';
                    document.getElementById('media-preview-name').textContent = '';
                    currentPostMedia = null;
                    document.getElementById('post-media').value = '';
                    showToast(msg, 'success');
                    loadFeed();
                } else {
                    showToast(msg, 'error');
                }
            } catch (err) {
                showToast(t('ERR_CONNECTION', 'Erro de conexao'), 'error');
            }
        }

        async function createCommunityPost() {
            const content = document.getElementById('community-post-content').value.trim();
            if (!content) return showToast(t('ERR_EMPTY_POST', 'Digite algo para publicar'), 'error');
            if (!currentCommunityId) return showToast(t('ERR_NO_COMMUNITY', 'Nenhuma comunidade selecionada'), 'error');

            const payload = { 
                content,
                community_id: currentCommunityId
            };

            if (currentCommunityPostMedia) {
                const base64 = await fileToBase64(currentCommunityPostMedia);
                payload.media_base64 = base64;
            }

            try {
                const res = await fetch(`${API_BASE}/api/posts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(payload)
                });

                if (res.status === 401) return handleUnauthorized();

                const msg = await getApiMessage(res, t('MSG_POST_CREATED', 'Post publicado!'));
                
                if (res.ok) {
                    document.getElementById('community-post-content').value = '';
                    document.getElementById('community-media-preview-name').textContent = '';
                    currentCommunityPostMedia = null;
                    document.getElementById('community-post-media').value = '';
                    showToast(msg, 'success');
                    loadCommunityPosts(currentCommunityId);
                } else {
                    showToast(msg, 'error');
                }
            } catch (err) {
                showToast(t('ERR_CONNECTION', 'Erro de conexao'), 'error');
            }
        }

        async function toggleLike(postId, btn) {
            // Se o bot√£o n√£o foi passado (chamada antiga), tenta achar
            if (!btn) btn = document.getElementById(`like-btn-${postId}`);

            // UI OPTIMISTIC UPDATE (Atualiza ANTES do servidor responder)
            const icon = btn.querySelector('.like-icon');
            const count = btn.querySelector('.like-count');
            const isLiked = icon.textContent.includes('‚ô•');
            
            // Inverte visualmente agora
            icon.textContent = isLiked ? '[‚ô°]' : '[‚ô•]';
            count.textContent = parseInt(count.textContent) + (isLiked ? -1 : 1);
            btn.classList.toggle('text-neon-lime');
            if (!isLiked) { // Se deu like, anima
                icon.style.transform = "scale(1.3)";
                setTimeout(() => icon.style.transform = "scale(1)", 200);
            }

            // Manda pro servidor em segundo plano
            try {
                await fetch(`${API_BASE}/api/likes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                    body: JSON.stringify({ post_id: postId })
                });
                // N√£o precisa fazer nada se der certo, j√° atualizamos a tela
            } catch (e) {
                // Se der erro, desfaz a altera√ß√£o visual (Rollback)
                icon.textContent = isLiked ? '[‚ù§Ô∏è]' : '[ü§ç]';
                count.textContent = parseInt(count.textContent) + (isLiked ? 1 : -1);
                btn.classList.toggle('text-neon-lime');
                showToast('Erro ao curtir', 'error');
            }
        }

        // ===========================================
        // COMENTARIOS INLINE
        // ===========================================
        async function toggleInlineComments(postId) {
            const container = document.getElementById(`inline-comments-${postId}`);
            const isHidden = container.classList.contains('hidden');
            
            if (isHidden) {
                container.classList.remove('hidden');
                await loadInlineComments(postId, false);
            } else {
                container.classList.add('hidden');
            }
        }

        async function loadInlineComments(postId, loadAll = false) {
            try {
                const res = await fetch(`${API_BASE}/api/posts/${postId}/comments`);
                const comments = await res.json();

                const listContainer = document.getElementById(`comments-list-${postId}`);
                const loadMoreBtn = document.getElementById(`comments-load-more-${postId}`);
                
                loadedCommentsCache[postId] = comments;
                
                if (!comments || comments.length === 0) {
                    listContainer.innerHTML = `<p class="text-gray-500 text-xs">${t('LBL_NO_COMMENTS', '> Sem comentarios ainda...')}</p>`;
                    loadMoreBtn.classList.add('hidden');
                    return;
                }

                const displayCount = loadAll ? comments.length : 5;
                const displayComments = comments.slice(-displayCount);
                
                listContainer.innerHTML = displayComments.map(c => `
                    <div class="bg-dark-900 border border-dark-700 rounded p-2">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-neon-green text-xs font-bold">@${escapeHtml(c.author || c.username || 'Usuario')}</span>
                            <span class="text-xs text-gray-600">${c.date || ''}</span>
                        </div>
                        <p class="text-sm text-gray-300">${escapeHtml(c.content)}</p>
                    </div>
                `).join('');

                if (comments.length > 5 && !loadAll) {
                    loadMoreBtn.classList.remove('hidden');
                } else {
                    loadMoreBtn.classList.add('hidden');
                }
            } catch (err) {
                console.error('Erro ao carregar comentarios:', err);
            }
        }

        function loadMoreComments(postId) {
            loadInlineComments(postId, true);
        }

        async function addInlineComment(e, postId) {
            e.preventDefault();
            const input = document.getElementById(`comment-input-${postId}`);
            const content = input.value.trim();

            if (!content) return;

            try {
                const res = await fetch(`${API_BASE}/api/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ post_id: parseInt(postId), content })
                });

                if (res.status === 401) return handleUnauthorized();

                if (res.ok) {
                    input.value = '';
                    const msg = await getApiMessage(res, t('MSG_COMMENT_ADDED', 'Comentario adicionado!'));
                    showToast(msg, 'success');
                    await loadInlineComments(postId, false);
                } else {
                    const err = await getApiMessage(res, t('ERR_COMMENT', 'Erro ao comentar'));
                    showToast(err, 'error');
                }
            } catch (err) {
                showToast(t('ERR_CONNECTION', 'Erro ao comentar'), 'error');
            }
        }

        // ===========================================
        // PERFIL (Blindado com friend_status)
        // ===========================================
        async function openProfile(userId) {
            if (!userId) return;
            const targetId = (userId == localStorage.getItem('cm_user_id')) ? 'me' : userId;
            
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById('page-profile').classList.remove('hidden');
            
            try {
                const res = await fetch(`${API_BASE}/api/users/${userId}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (res.ok) {
                    const user = await res.json();
                    renderUserProfile(user); 
                    showSection('profile'); 
                } else {
                    showToast(t('ERR_USER_NOT_FOUND', 'Usuario nao encontrado'), 'error');
                }

                if (res.status === 401) return handleUnauthorized();
                if (res.status === 404) {
                    document.getElementById('profile-content').innerHTML = `
                        <div class="bg-dark-800 border border-dark-600 rounded-lg p-8 text-center">
                            <p class="text-red-400">${t('ERR_USER_NOT_FOUND', '> Usuario nao encontrado')}</p>
                        </div>
                    `;
                    return;
                }

                const profile = await res.json();
                renderProfile(profile);
                
                if (!profile.is_locked) {
                    await loadUserTimeline(userId);
                } else {
                    document.getElementById('profile-timeline').innerHTML = `
                        <div class="bg-dark-800 border border-dark-600 rounded-lg p-8 text-center">
                            <p class="text-gray-500">${t('LBL_PRIVATE_PROFILE', '> Perfil privado. Adicione como amigo para ver os posts.')}</p>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Erro ao carregar perfil:', err);
            }
        }

        function renderProfile(profile) {
            const container = document.getElementById('profile-content');
            
            let actionButton = '';
            switch (profile.friend_status) {
                case 'self':
                    actionButton = `<span class="text-neon-cyan text-sm">[${t('LBL_YOUR_PROFILE', 'SEU PERFIL')}]</span>`;
                    break;
                case 'friend':
                    actionButton = `<span class="text-neon-lime text-sm">[${t('LBL_FRIENDS', 'AMIGOS')}]</span>`;
                    break;
                case 'pending_sent':
                    actionButton = `<span class="text-yellow-500 text-sm">[${t('LBL_PENDING', 'PENDENTE')}]</span>`;
                    break;
                case 'pending_received':
                    actionButton = `
                        <div class="flex gap-2">
                            <button onclick="respondFriendRequest(${profile.id}, 'accept')" class="bg-neon-green text-dark-900 px-3 py-1 rounded text-sm font-bold hover:bg-neon-lime">[${t('UI_BTN_ACCEPT', 'ACEITAR')}]</button>
                            <button onclick="respondFriendRequest(${profile.id}, 'reject')" class="bg-red-600/20 border border-red-600 text-red-400 px-3 py-1 rounded text-sm font-bold hover:bg-red-600 hover:text-white">[${t('UI_BTN_REJECT', 'RECUSAR')}]</button>
                        </div>
                    `;
                    break;
                default:
                    actionButton = `<button onclick="sendFriendRequest(${profile.id})" class="bg-neon-green text-dark-900 px-3 py-1 rounded text-sm font-bold hover:bg-neon-lime">[+ ${t('UI_BTN_ADD_FRIEND', 'ADICIONAR')}]</button>`;
            }
            
            container.innerHTML = `
                <!-- Profile cover -->
                <div class="relative h-32 rounded-t-lg bg-cover bg-center" style="background-image: url('${DEFAULT_COVER}');">
                    <div class="absolute inset-0 bg-gradient-to-t from-dark-800 to-transparent rounded-t-lg"></div>
                </div>
                <div class="bg-dark-800 border border-dark-600 border-t-0 rounded-b-lg p-6 -mt-1">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center gap-4 -mt-12">
                            <!-- Avatar with frame -->
                            <img src="${DEFAULT_AVATAR(profile.username)}" alt="${escapeHtml(profile.username)}" class="w-20 h-20 rounded-full avatar-frame bg-dark-800">
                            <div class="mt-8">
                                <div class="flex items-center gap-2">
                                    <h2 class="text-xl font-bold text-neon-green">@${escapeHtml(profile.username)}</h2>
                                    ${profile.is_verified ? '<span class="text-neon-cyan text-xs">[VERIFICADO]</span>' : ''}
                                    ${profile.is_locked ? '<span class="text-red-400 text-xs">[PRIVADO]</span>' : ''}
                                </div>
                                <p class="text-gray-500 text-sm">${escapeHtml(profile.location || t('LBL_UNKNOWN_LOC', 'Localizacao desconhecida'))}</p>
                                <!-- Date formatted as Month/Year -->
                                <p class="text-gray-600 text-xs">${t('LBL_JOINED', 'Membro desde')}: ${formatJoinDate(profile.joined_at)}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 mt-4">
                            ${actionButton}
                            ${profile.friend_status !== 'self' ? `<button onclick="openReportModal(${profile.id}, 1)" class="text-gray-500 hover:text-red-400" title="${t('UI_TITLE_REPORT', 'Denunciar')}">[!]</button>` : ''}
                        </div>
                    </div>
                    <div class="border-t border-dark-600 pt-4">
                        <p class="text-gray-300">${escapeHtml(profile.bio || t('LBL_NO_BIO', 'Sem bio'))}</p>
                    </div>
                </div>
            `;
        }

        async function loadUserTimeline(userId) {
            try {
                const res = await fetch(`${API_BASE}/api/users/${userId}/posts`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const posts = await res.json();
                const container = document.getElementById('profile-timeline');
                
                if (!posts || posts.length === 0) {
                    container.innerHTML = `
                        <div class="bg-dark-800 border border-dark-600 rounded-lg p-8 text-center">
                            <p class="text-gray-500">${t('LBL_NO_POSTS', '> Nenhum post encontrado')}</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = posts.map(post => `
                    <div class="bg-dark-800 border border-dark-600 rounded-lg p-4">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <span class="text-neon-green font-bold">@${escapeHtml(post.author || 'Usuario')}</span>
                                <span class="text-gray-500 text-sm ml-2">${escapeHtml(post.origin || '')}</span>
                            </div>
                            <button onclick="openReportModal(${post.id}, 2)" class="text-gray-500 hover:text-red-400 text-sm">[!]</button>
                        </div>
                        <p class="text-gray-300 whitespace-pre-wrap">${escapeHtml(post.content)}</p>
                        ${renderMedia(post)}
                        <div class="flex items-center gap-4 mt-3 pt-3 border-t border-dark-600">
                            <span class="text-sm text-gray-500">${post.likes || 0} likes</span>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Erro ao carregar timeline:', err);
            }
        }

        // ===========================================
        // COMUNIDADES (REMAKE COMPLETO)
        // ===========================================
        async function loadCommunities() {
            try {
                const res = await fetch(`${API_BASE}/api/communities`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (res.status === 401) return handleUnauthorized();

                const communities = await res.json();
                const container = document.getElementById('communities-list');
                
                if (!communities || communities.length === 0) {
                    container.innerHTML = `
                        <div class="bg-dark-800 border border-dark-600 rounded-lg p-6 col-span-full text-center">
                            <p class="text-gray-500">${t('LBL_NO_COMMUNITIES', '> Nenhuma comunidade encontrada...')}</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = communities.map(c => `
                    <div class="bg-dark-800 border border-dark-600 rounded-lg overflow-hidden hover:border-neon-green/50 transition-colors">
                        <div class="h-24 bg-cover bg-center" style="background-image: url('https://picsum.photos/seed/${c.id}/400/100');"></div>
                        <div class="p-4">
                            <div class="flex items-start justify-between mb-2">
                                <button onclick="openCommunity(${c.id})" class="text-neon-green font-bold text-lg hover:text-neon-lime transition-colors text-left">
                                    &gt; ${escapeHtml(c.name)}
                                </button>
                                <span class="text-xs text-gray-500">${c.members || 0} ${t('LBL_MEMBERS', 'membros')}</span>
                            </div>
                            <p class="text-gray-400 text-sm mb-3">${escapeHtml(c.description || t('LBL_NO_DESC', 'Sem descricao'))}</p>
                            ${c.location ? `<p class="text-gray-600 text-xs mb-3">${escapeHtml(c.location)}</p>` : ''}
                            <button onclick="joinCommunity(${c.id})" class="w-full bg-neon-green/20 border border-neon-green text-neon-green px-4 py-2 rounded font-bold hover:bg-neon-green hover:text-dark-900 transition-colors text-sm">
                                [JOIN TERMINAL]
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Erro ao carregar comunidades:', err);
            }
        }

        async function joinCommunity(communityId) {
            try {
                const res = await fetch(`${API_BASE}/api/communities/request`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ community_id: communityId })
                });

                if (res.status === 401) return handleUnauthorized();

                const responseText = await res.text();
                
                if (responseText === 'JOINED_DIRECTLY') {
                    showToast(t('MSG_JOINED_DIRECTLY', 'Voce entrou na comunidade!'), 'success');
                    loadCommunities();
                } else if (responseText === 'REQUEST_SENT') {
                    showToast(t('MSG_REQ_SENT', 'Solicitacao enviada! Aguarde aprovacao.'), 'info');
                } else {
                    showToast(responseText || t('ERR_JOIN', 'Erro ao entrar'), res.ok ? 'success' : 'error');
                }
            } catch (err) {
                showToast(t('ERR_CONNECTION', 'Erro de conexao'), 'error');
            }
        }

        async function openCommunity(communityId) {
            currentCommunityId = communityId;
            
            document.getElementById('communities-list').classList.add('hidden');
            document.getElementById('community-dashboard').classList.remove('hidden');
            document.getElementById('back-to-communities').classList.remove('hidden');
            document.getElementById('create-community-btn').classList.add('hidden');
            
            try {
                // Load community info
                const commRes = await fetch(`${API_BASE}/api/communities`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const communities = await commRes.json();
                const comm = communities.find(c => c.id === communityId);
                
                if (comm) {
                    currentCommunityData = comm;
                    document.getElementById('community-cover').style.backgroundImage = `url('https://picsum.photos/seed/${comm.id}/800/200')`;
                    document.getElementById('community-dash-name').textContent = `> ${comm.name}`;
                    document.getElementById('community-dash-desc').textContent = comm.description || t('LBL_NO_DESC', 'Sem descricao');
                    document.getElementById('community-dash-location').textContent = comm.location || '';
                    document.getElementById('community-dash-members').textContent = `${comm.members || 0} ${t('LBL_MEMBERS', 'membros')}`;
                    document.getElementById('communities-title').innerHTML = `&gt; ${escapeHtml(comm.name)}`;
                }
                
                // Check membership and role
                const membersRes = await fetch(`${API_BASE}/api/communities/${communityId}/members`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const members = await membersRes.json();
                
                // Find current user in members
                const currentUserMember = members.find(m => m.username === currentUser);
                currentCommunityRole = currentUserMember ? currentUserMember.role : null;
                
                // Update action button
                const actionContainer = document.getElementById('community-action-btn');
                if (currentCommunityRole !== null) {
                    // User is a member
                    document.getElementById('community-create-post').classList.remove('hidden');
                    actionContainer.innerHTML = `<span class="text-neon-lime text-sm">[${t('LBL_MEMBER', 'MEMBRO')}]</span>`;
                    
                    // Show admin tab if admin/master
                    if (currentCommunityRole <= 2) {
                        document.getElementById('comm-tab-admin').classList.remove('hidden');
                    } else {
                        document.getElementById('comm-tab-admin').classList.add('hidden');
                    }
                } else {
                    // Not a member
                    document.getElementById('community-create-post').classList.add('hidden');
                    document.getElementById('comm-tab-admin').classList.add('hidden');
                    actionContainer.innerHTML = `
                        <button onclick="joinCommunity(${communityId})" class="bg-neon-green text-dark-900 px-4 py-2 rounded font-bold hover:bg-neon-lime transition-colors">
                            [JOIN TERMINAL]
                        </button>
                    `;
                }
                
                // Load feed tab by default
                switchCommunityTab('feed');
            } catch (err) {
                console.error('Erro ao abrir comunidade:', err);
            }
        }

        function switchCommunityTab(tab) {
            const tabs = ['feed', 'members', 'admin'];
            tabs.forEach(t => {
                document.getElementById(`comm-tab-${t}`).classList.remove('text-neon-cyan', 'border-neon-cyan');
                document.getElementById(`comm-tab-${t}`).classList.add('text-gray-500', 'border-transparent');
                document.getElementById(`community-tab-${t}`).classList.add('hidden');
            });
            
            document.getElementById(`comm-tab-${tab}`).classList.add('text-neon-cyan', 'border-neon-cyan');
            document.getElementById(`comm-tab-${tab}`).classList.remove('text-gray-500', 'border-transparent');
            document.getElementById(`community-tab-${tab}`).classList.remove('hidden');
            
            if (tab === 'feed') {
                loadCommunityPosts(currentCommunityId);
            } else if (tab === 'members') {
                loadCommunityMembers(currentCommunityId);
            } else if (tab === 'admin') {
                loadCommunityPendingRequests(currentCommunityId);
            }
        }

        async function loadCommunityPosts(communityId) {
            try {
                const res = await fetch(`${API_BASE}/api/communities/${communityId}/posts`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (res.status === 401) return handleUnauthorized();
                if (res.status === 403) {
                    const msg = await getApiMessage(res, t('ERR_PRIVATE_COMMUNITY', 'Comunidade privada'));
                    document.getElementById('community-posts').innerHTML = `
                        <div class="bg-dark-800 border border-dark-600 rounded-lg p-8 text-center">
                            <p class="text-red-400">&gt; ${escapeHtml(msg)}</p>
                        </div>
                    `;
                    return;
                }

                const posts = await res.json();
                renderPosts(posts, 'community-posts');
            } catch (err) {
                console.error('Erro ao carregar posts da comunidade:', err);
            }
        }

        async function loadCommunityMembers(communityId) {
            try {
                const res = await fetch(`${API_BASE}/api/communities/${communityId}/members`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const members = await res.json();
                const container = document.getElementById('community-members-list');
                
                if (!members || members.length === 0) {
                    container.innerHTML = `<p class="text-gray-500">${t('LBL_NO_MEMBERS', '> Nenhum membro encontrado')}</p>`;
                    return;
                }
                
                const roleLabels = {
                    1: '[MASTER]',
                    2: '[ADMIN]',
                    3: '[MEMBRO]'
                };
                
                container.innerHTML = members.map(m => {
                    const roleLabel = roleLabels[m.role] || '[MEMBRO]';
                    const roleColor = m.role === 1 ? 'text-yellow-400' : m.role === 2 ? 'text-neon-cyan' : 'text-gray-500';
                    const friendClass = m.is_friend ? 'friend-highlight border-2' : '';
                    const canKick = currentCommunityRole && currentCommunityRole <= 2 && m.role > currentCommunityRole && m.username !== currentUser;
                    
                    return `
                        <div class="bg-dark-800 border border-dark-600 rounded p-3 flex items-center justify-between ${friendClass}">
                            <button onclick="openProfile(${m.id})" class="flex items-center gap-3 text-left">
                                <img src="${DEFAULT_AVATAR(m.username)}" alt="" class="w-10 h-10 rounded-full ${m.is_friend ? 'avatar-frame' : ''}">
                                <div>
                                    <span class="text-neon-green font-bold hover:text-neon-lime ${m.is_friend ? 'text-neon-lime' : ''}">@${escapeHtml(m.username)}</span>
                                    <span class="${roleColor} text-xs ml-2">${roleLabel}</span>
                                    ${m.is_friend ? '<span class="text-xs text-neon-lime ml-1">[AMIGO]</span>' : ''}
                                </div>
                            </button>
                            ${canKick ? `<button onclick="kickMember(${communityId}, ${m.id})" class="text-red-400 hover:text-red-300 text-sm" title="${t('UI_BTN_KICK', 'Remover')}">üóëÔ∏è</button>` : ''}
                        </div>
                    `;
                }).join('');
            } catch (err) {
                console.error('Erro ao carregar membros:', err);
            }
        }

        async function loadCommunityPendingRequests(communityId) {
            try {
                const res = await fetch(`${API_BASE}/api/communities/${communityId}/requests`);
                const requests = await res.json();
                const container = document.getElementById('community-pending-requests');
                
                if (!requests || requests.length === 0) {
                    container.innerHTML = `<p class="text-gray-500">${t('LBL_NO_PENDING', '> Nenhuma solicitacao pendente')}</p>`;
                    return;
                }
                
                container.innerHTML = requests.map(r => `
                    <div class="bg-dark-900 border border-dark-700 rounded p-3 flex items-center justify-between">
                        <button onclick="openProfile(${r.id})" class="flex items-center gap-3 text-left">
                            <img src="${DEFAULT_AVATAR(r.username)}" alt="" class="w-10 h-10 rounded-full">
                            <div>
                                <span class="text-neon-green font-bold">@${escapeHtml(r.username)}</span>
                                <p class="text-sm text-gray-500">${escapeHtml(r.bio || '')}</p>
                            </div>
                        </button>
                        <div class="flex gap-2">
                            <button onclick="respondCommunityRequest(${communityId}, ${r.id}, 'accept')" class="bg-neon-green text-dark-900 w-10 h-10 rounded font-bold hover:bg-neon-lime text-lg">[V]</button>
                            <button onclick="respondCommunityRequest(${communityId}, ${r.id}, 'reject')" class="bg-red-600/20 border border-red-600 text-red-400 w-10 h-10 rounded font-bold hover:bg-red-600 hover:text-white text-lg">[X]</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Erro ao carregar solicitacoes:', err);
            }
        }

        async function respondCommunityRequest(communityId, userId, action) {
            try {
                const res = await fetch(`${API_BASE}/api/communities/respond_request`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ community_id: communityId, user_id: userId, action })
                });
                
                const msg = await getApiMessage(res, res.ok ? t('MSG_REQ_PROCESSED', 'Solicitacao processada!') : t('ERR_PROCESS', 'Erro'));
                showToast(msg, res.ok ? 'success' : 'error');
                
                if (res.ok) {
                    loadCommunityPendingRequests(communityId);
                    loadCommunityMembers(communityId);
                }
            } catch (err) {
                showToast(t('ERR_CONNECTION', 'Erro de conexao'), 'error');
            }
        }

        async function kickMember(communityId, targetId) {
            if (!confirm(t('CONFIRM_KICK', 'Tem certeza que deseja remover este membro?'))) return;
            
            try {
                const res = await fetch(`${API_BASE}/api/communities/remove_member`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ community_id: communityId, admin_id: 0, target_id: targetId })
                });
                
                const msg = await getApiMessage(res, res.ok ? t('MSG_MEMBER_REMOVED', 'Membro removido!') : t('ERR_REMOVE', 'Erro ao remover'));
                showToast(msg, res.ok ? 'success' : 'error');
                
                if (res.ok) {
                    loadCommunityMembers(communityId);
                }
            } catch (err) {
                showToast(t('ERR_CONNECTION', 'Erro de conexao'), 'error');
            }
        }

        async function leaveCommunity() {
            if (!confirm(t('CONFIRM_LEAVE', 'Tem certeza que deseja sair desta comunidade?'))) return;
            
            try {
                const res = await fetch(`${API_BASE}/api/communities/leave`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ community_id: currentCommunityId })
                });
                
                const msg = await getApiMessage(res, res.ok ? t('MSG_LEAVE_COMM', 'Voce saiu da comunidade!') : t('ERR_LEAVE', 'Erro ao sair'));
                showToast(msg, res.ok ? 'success' : 'error');
                
                if (res.ok) {
                    backToCommunities();
                    loadCommunities();
                }
            } catch (err) {
                showToast(t('ERR_CONNECTION', 'Erro de conexao'), 'error');
            }
        }

        function backToCommunities() {
            currentCommunityId = null;
            currentCommunityData = null;
            currentCommunityRole = null;
            document.getElementById('communities-list').classList.remove('hidden');
            document.getElementById('community-dashboard').classList.add('hidden');
            document.getElementById('back-to-communities').classList.add('hidden');
            document.getElementById('create-community-btn').classList.remove('hidden');
            document.getElementById('communities-title').innerHTML = `&gt; ${t('UI_TITLE_COMMUNITIES', 'COMUNIDADES')}`;
        }

        async function createCommunity(e) {
            e.preventDefault();
            const name = document.getElementById('community-name').value.trim();
            const description = document.getElementById('community-description').value.trim();
            const state = document.getElementById('community-state').value;
            const city = document.getElementById('community-city').value;

            try {
                const res = await fetch(`${API_BASE}/api/communities`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ name, description, state, city })
                });

                if (res.status === 401) return handleUnauthorized();

                const msg = await getApiMessage(res, res.ok ? t('MSG_COMM_CREATED', 'Comunidade criada!') : t('ERR_CREATE_COMM', 'Erro ao criar comunidade'));
                
                if (res.ok) {
                    closeModal('create-community-modal');
                    showToast(msg, 'success');
                    document.getElementById('community-name').value = '';
                    document.getElementById('community-description').value = '';
                    document.getElementById('community-state').value = '';
                    document.getElementById('community-city').innerHTML = '<option value="">Opcional...</option>';
                    loadCommunities();
                } else {
                    showToast(msg, 'error');
                }
            } catch (err) {
                showToast(t('ERR_CONNECTION', 'Erro de conexao'), 'error');
            }
        }

        // ===========================================
        // AMIGOS & BUSCA
        // ===========================================
        function debounceSearch(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => searchUsers(), 500);
        }

        function switchFriendsTab(tab) {
            const pendingTab = document.getElementById('friends-tab-pending');
            const listTab = document.getElementById('friends-tab-list');
            const pendingContainer = document.getElementById('pending-requests');
            const listContainer = document.getElementById('friends-list');

            if (tab === 'pending') {
                pendingTab.classList.add('text-neon-cyan', 'border-neon-cyan');
                pendingTab.classList.remove('text-gray-500', 'border-transparent');
                listTab.classList.remove('text-neon-cyan', 'border-neon-cyan');
                listTab.classList.add('text-gray-500', 'border-transparent');
                pendingContainer.classList.remove('hidden');
                listContainer.classList.add('hidden');
                loadPendingRequests();
            } else {
                listTab.classList.add('text-neon-cyan', 'border-neon-cyan');
                listTab.classList.remove('text-gray-500', 'border-transparent');
                pendingTab.classList.remove('text-neon-cyan', 'border-neon-cyan');
                pendingTab.classList.add('text-gray-500', 'border-transparent');
                listContainer.classList.remove('hidden');
                pendingContainer.classList.add('hidden');
                loadFriendsList();
            }
        }

        async function searchUsers() {
            const query = document.getElementById('search-users').value.trim();
            if (!query) {
                document.getElementById('search-results').innerHTML = '';
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/search?q=${encodeURIComponent(query)}`);
                const users = await res.json();

                const container = document.getElementById('search-results');
                if (!users || users.length === 0) {
                    container.innerHTML = `<p class="text-gray-500">${t('LBL_NO_USERS', '> Nenhum usuario encontrado')}</p>`;
                } else {
                    container.innerHTML = users.map(u => `
                        <div class="bg-dark-800 border border-dark-600 rounded p-3 flex items-center justify-between hover:border-neon-green/50 transition-colors">
                            <button onclick="openProfile(${u.id})" class="flex items-center gap-3 text-left flex-1">
                                <img src="${DEFAULT_AVATAR(u.username)}" alt="" class="w-10 h-10 rounded-full avatar-frame">
                                <div>
                                    <span class="text-neon-green font-bold hover:text-neon-lime">@${escapeHtml(u.username)}</span>
                                    <p class="text-sm text-gray-500">${escapeHtml(u.bio || t('LBL_NO_BIO', 'Sem bio'))}</p>
                                </div>
                            </button>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Erro na busca:', err);
            }
        }

        async function sendFriendRequest(toId) {
            try {
                const res = await fetch(`${API_BASE}/api/friends/request`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ to_id: toId })
                });

                if (res.status === 401) return handleUnauthorized();

                const msg = await getApiMessage(res, res.ok ? t('MSG_REQ_SENT', 'Solicitacao enviada!') : t('ERR_REQ_EXIST', 'Solicitacao ja existe'));
                showToast(msg, res.ok ? 'success' : 'error');
                
                if (!document.getElementById('page-profile').classList.contains('hidden')) {
                    openProfile(toId);
                }
            } catch (err) {
                showToast(t('ERR_CONNECTION', 'Erro de conexao'), 'error');
            }
        }

        async function loadPendingRequests() {
            try {
                const res = await fetch(`${API_BASE}/api/friends/pending`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (res.status === 401) return handleUnauthorized();

                const data = await res.json();
                const container = document.getElementById('pending-requests');
                const requests = Array.isArray(data) ? data : (data.requests || []);

                if (!requests || requests.length === 0) {
                    container.innerHTML = `<p class="text-gray-500">${t('LBL_NO_PENDING', '> Nenhuma solicitacao pendente')}</p>`;
                } else {
                    container.innerHTML = requests.map(r => {
                        const username = r.username || r.requester_username || 'Usuario';
                        const requesterId = r.requester_id || r.id;
                        
                        return `
                            <div class="bg-dark-800 border border-dark-600 rounded p-3 flex items-center justify-between">
                                <button onclick="openProfile(${requesterId})" class="flex items-center gap-3 text-left">
                                    <img src="${DEFAULT_AVATAR(username)}" alt="" class="w-10 h-10 rounded-full avatar-frame">
                                    <div>
                                        <span class="text-neon-green font-bold hover:text-neon-lime">@${escapeHtml(username)}</span>
                                        <p class="text-sm text-gray-500">${t('LBL_WANTS_FRIEND', 'Quer ser seu amigo')}</p>
                                    </div>
                                </button>
                                <div class="flex gap-2">
                                    <button onclick="respondFriendRequest(${requesterId}, 'accept')" class="bg-neon-green text-dark-900 w-10 h-10 rounded font-bold hover:bg-neon-lime text-lg" title="${t('UI_BTN_ACCEPT', 'Aceitar')}">[V]</button>
                                    <button onclick="respondFriendRequest(${requesterId}, 'reject')" class="bg-red-600/20 border border-red-600 text-red-400 w-10 h-10 rounded font-bold hover:bg-red-600 hover:text-white text-lg" title="${t('UI_BTN_REJECT', 'Recusar')}">[X]</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (err) {
                console.error('Erro ao carregar solicitacoes:', err);
            }
        }

        async function loadFriendsList() {
            try {
                const res = await fetch(`${API_BASE}/api/friends`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (res.status === 401) return handleUnauthorized();

                const friends = await res.json();
                const container = document.getElementById('friends-list');

                if (!friends || friends.length === 0) {
                    container.innerHTML = `<p class="text-gray-500">${t('LBL_NO_FRIENDS', '> Voce ainda nao tem amigos adicionados')}</p>`;
                } else {
                    container.innerHTML = friends.map(f => `
                        <div class="bg-dark-800 border border-dark-600 rounded p-3 flex items-center justify-between">
                            <button onclick="openProfile(${f.id})" class="flex items-center gap-3 text-left">
                                <img src="${DEFAULT_AVATAR(f.username)}" alt="" class="w-10 h-10 rounded-full avatar-frame">
                                <div>
                                    <span class="text-neon-green font-bold hover:text-neon-lime">@${escapeHtml(f.username)}</span>
                                    <p class="text-sm text-gray-500">${escapeHtml(f.bio || t('LBL_NO_BIO', 'Sem bio'))}</p>
                                </div>
                            </button>
                            <span class="text-xs text-neon-lime">[CONNECTED]</span>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Erro ao carregar amigos:', err);
            }
        }

        async function respondFriendRequest(requesterId, action) {
            try {
                const res = await fetch(`${API_BASE}/api/friends/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ requester_id: requesterId, action })
                });

                if (res.status === 401) return handleUnauthorized();

                const msg = await getApiMessage(res, res.ok ? (action === 'accept' ? t('MSG_FRIEND_ACCEPTED', 'Amizade aceita!') : t('MSG_FRIEND_REJECTED', 'Solicitacao recusada')) : t('ERR_PROCESS', 'Erro ao processar'));
                showToast(msg, res.ok ? 'success' : 'error');
                
                if (res.ok) {
                    loadPendingRequests();
                    loadNotificationsCount();
                    
                    if (!document.getElementById('page-profile').classList.contains('hidden')) {
                        openProfile(requesterId);
                    }
                }
            } catch (err) {
                showToast(t('ERR_PROCESS', 'Erro ao processar'), 'error');
            }
        }

        // ===========================================
        // NOTIFICACOES INTELIGENTES
        // ===========================================
        async function loadNotificationAlerts() {
            try {
                const res = await fetch(`${API_BASE}/api/notifications`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (res.status === 401) return handleUnauthorized();

                const data = await res.json();
                // Garante que √© array (seja lista direta ou objeto com chave notifications)
                const notifications = Array.isArray(data) ? data : (data.notifications || []);
                const container = document.getElementById('notifications-alerts');

                if (notifications.length === 0) {
                    container.innerHTML = `<p class="text-gray-500 text-center py-4">Nenhuma notifica√ß√£o.</p>`;
                    return;
                }

                container.innerHTML = notifications.map(n => {
                    // Texto Inteligente
                    let text = n.message || 'Nova notifica√ß√£o';
                    // Tenta achar o nome do remetente
                    const name = n.sender_name || n.username || 'Algu√©m';
                    
                    if (n.type === 1) text = `<strong>@${name}</strong> curtiu seu post.`;
                    if (n.type === 2) text = `<strong>@${name}</strong> comentou no seu post.`;
                    if (n.type === 3) text = `<strong>@${name}</strong> enviou solicita√ß√£o.`;
                    if (n.type === 4) text = `<strong>@${name}</strong> te convidou para comunidade.`;

                    // Estilo: Lidas ficam apagadas, Novas ficam brilhando
                    const bgClass = n.read ? 'bg-dark-900 border-dark-600 opacity-60' : 'bg-dark-800 border-neon-cyan glow';
                    
                    // A√ß√£o de clique
                    let action = '';
                    if (n.type === 1 || n.type === 2) action = "showSection('feed')";
                    if (n.type === 3) action = "switchNotifTab('requests')";
                    if (n.type === 4 && n.community_id) action = `openCommunity(${n.community_id})`;

                    return `
                        <div class="${bgClass} border rounded p-3 mb-2 cursor-pointer hover:bg-dark-700 transition-all relative" onclick="${action}">
                            <p class="text-sm text-gray-300">${text}</p>
                            <span class="text-xs text-gray-500 block mt-1">${n.created_at || ''}</span>
                            ${!n.read ? '<span class="absolute top-2 right-2 w-2 h-2 bg-neon-cyan rounded-full"></span>' : ''}
                        </div>
                    `;
                }).join('');
                
            } catch (err) {
                console.error(err);
            }
        }

        function switchNotifTab(tab) {
            const alertsTab = document.getElementById('notif-tab-alerts');
            const requestsTab = document.getElementById('notif-tab-requests');
            const alertsContainer = document.getElementById('notifications-alerts');
            const requestsContainer = document.getElementById('notifications-requests');

            if (tab === 'alerts') {
                alertsTab.classList.add('text-neon-cyan', 'border-neon-cyan');
                alertsTab.classList.remove('text-gray-500', 'border-transparent');
                requestsTab.classList.remove('text-neon-cyan', 'border-neon-cyan');
                requestsTab.classList.add('text-gray-500', 'border-transparent');
                alertsContainer.classList.remove('hidden');
                requestsContainer.classList.add('hidden');
                loadNotificationAlerts();
            } else {
                requestsTab.classList.add('text-neon-cyan', 'border-neon-cyan');
                requestsTab.classList.remove('text-gray-500', 'border-transparent');
                alertsTab.classList.remove('text-neon-cyan', 'border-neon-cyan');
                alertsTab.classList.add('text-gray-500', 'border-transparent');
                requestsContainer.classList.remove('hidden');
                alertsContainer.classList.add('hidden');
                loadNotificationRequests();
            }
        }

        // Interpreta os c√≥digos do Router.cpp (1=Like, 2=Comment, etc)
        function buildNotificationText(n) {
            // Backend pode mandar 'sender_name' ou 'username', o front garante os dois
            const name = n.sender_name || n.username || 'Algu√©m';
            
            switch (n.type) {
                case 1: return `<strong>@${name}</strong> curtiu seu post.`;
                case 2: return `<strong>@${name}</strong> comentou: "${escapeHtml(n.content || '')}"`;
                case 3: return `<strong>@${name}</strong> enviou solicita√ß√£o de amizade.`;
                case 4: return `<strong>@${name}</strong> convidou para comunidade.`;
                default: return n.message || 'Nova notifica√ß√£o';
            }
        }

        function getNotificationClickHandler(n) {
            // Aqui resolvemos o redirecionamento
            switch (n.type) {
                case 1: // Like
                case 2: // Comment
                    // Se tiver ID do post, tenta ir pra ele (ou pro feed se n√£o tivermos view de post unico ainda)
                    // O ideal seria criar uma fun√ß√£o loadSinglePost(id), mas por enquanto vamos pro feed
                    return n.post_id ? `showSection('feed'); /* TODO: Scroll to post ${n.post_id} */` : '';
                
                case 3: // Friend request - Vai pra aba de Requests
                    return `switchNotifTab('requests')`;
                
                case 4: // Community - Vai pra comunidade
                    return n.community_id ? `openCommunity(${n.community_id})` : '';
                
                default:
                    return '';
            }
        }

        async function loadNotificationAlerts() {
            try {
                const res = await fetch(`${API_BASE}/api/notifications`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                const list = Array.isArray(data) ? data : (data.notifications || []);
                
                const container = document.getElementById('notifications-alerts');
                if(list.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 p-4">Nada por aqui.</p>';
                    return;
                }

                container.innerHTML = list.map(n => {
                    // Se read=false, usa borda Neon. Se true, fica cinza.
                    const style = n.read 
                        ? 'bg-dark-900 border-dark-600 opacity-60' 
                        : 'bg-dark-800 border-neon-cyan glow';
                        
                    // A√ß√£o de clique
                    let action = '';
                    if(n.type == 3) action = "switchNotifTab('requests')";
                    else if(n.type == 4) action = `openCommunity(${n.community_id})`;
                    else action = "showSection('home')"; // Ou openPost(n.post_id) no futuro

                    return `
                    <div class="${style} border rounded p-3 mb-2 cursor-pointer hover:bg-dark-700 relative" onclick="${action}">
                        <p class="text-sm text-gray-300">${buildNotificationText(n)}</p>
                        <span class="text-xs text-gray-500">${n.created_at || ''}</span>
                        ${!n.read ? '<span class="absolute top-2 right-2 w-2 h-2 bg-neon-cyan rounded-full"></span>' : ''}
                    </div>`;
                }).join('');
                
                // Atualiza badge (conta s√≥ as false)
                const unread = list.filter(x => !x.read).length;
                updateNotificationBadge(unread); // Certifique-se que essa func existe ou crie uma simples

            } catch (e) { console.error(e); }
        }

        async function loadNotificationRequests() {
            try {
                const res = await fetch(`${API_BASE}/api/friends/pending`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (res.status === 401) return handleUnauthorized();

                const data = await res.json();
                const container = document.getElementById('notifications-requests');
                const requests = Array.isArray(data) ? data : (data.requests || []);

                if (!requests || requests.length === 0) {
                    container.innerHTML = `<p class="text-gray-500">${t('LBL_NO_PENDING', '> Nenhuma solicitacao pendente')}</p>`;
                } else {
                    container.innerHTML = requests.map(r => {
                        const username = r.username || r.requester_username || 'Usuario';
                        const requesterId = r.requester_id || r.id;
                        
                        return `
                            <div class="bg-dark-800 border border-neon-cyan rounded p-3 glow">
                                <div class="flex items-center justify-between">
                                    <button onclick="openProfile(${requesterId})" class="flex items-center gap-3 text-left">
                                        <img src="${DEFAULT_AVATAR(username)}" alt="" class="w-10 h-10 rounded-full avatar-frame">
                                        <div>
                                            <span class="text-neon-green font-bold hover:text-neon-lime">@${escapeHtml(username)}</span>
                                            <p class="text-sm text-gray-400">${t('LBL_SENT_REQUEST', 'Enviou uma solicitacao de amizade')}</p>
                                        </div>
                                    </button>
                                    <div class="flex gap-2">
                                        <button onclick="respondFriendRequest(${requesterId}, 'accept')" class="bg-neon-green text-dark-900 w-10 h-10 rounded font-bold hover:bg-neon-lime text-lg" title="${t('UI_BTN_ACCEPT', 'Aceitar')}">[V]</button>
                                        <button onclick="respondFriendRequest(${requesterId}, 'reject')" class="bg-red-600/20 border border-red-600 text-red-400 w-10 h-10 rounded font-bold hover:bg-red-600 hover:text-white text-lg" title="${t('UI_BTN_REJECT', 'Recusar')}">[X]</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (err) {
                console.error('Erro ao carregar solicitacoes:', err);
            }
        }

        function updateNotificationBadge(notifications) {
            const badge = document.getElementById('notif-badge');
            const unreadCount = notifications.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        async function loadNotificationsCount() {
            try {
                const res = await fetch(`${API_BASE}/api/notifications`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (res.ok) {
                    const data = await res.json();
                    const notifications = Array.isArray(data) ? data : (data.notifications || []);
                    updateNotificationBadge(notifications);
                }
            } catch (err) {
                // Silently fail
            }
        }

        async function markNotificationsRead() {
            try {
                const res = await fetch(`${API_BASE}/api/notifications/read`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const msg = await getApiMessage(res, t('MSG_NOTIFICATIONS_READ', 'Notificacoes marcadas como lidas'));
                showToast(msg, 'success');
                loadNotificationAlerts();
                updateNotificationBadge([]);
            } catch (err) {
                console.error('Erro:', err);
            }
        }

        // ===========================================
        // CONFIGURACOES & PERFIL
        // ===========================================
        async function updateProfile() {
            const bio = document.getElementById('settings-bio').value;
            const email = document.getElementById('settings-email').value;
            const birthDate = document.getElementById('settings-birthdate').value;
            const isPrivate = document.getElementById('settings-private').checked;

            try {
                const res = await fetch(`${API_BASE}/api/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        bio,
                        email,
                        birth_date: birthDate,
                        is_private: isPrivate
                    })
                });

                if (res.status === 401) return handleUnauthorized();

                const msg = await getApiMessage(res, res.ok ? t('MSG_PROFILE_UPDATED', 'Perfil atualizado!') : t('ERR_UPDATE', 'Erro ao atualizar'));
                showToast(msg, res.ok ? 'success' : 'error');
            } catch (err) {
                showToast(t('ERR_CONNECTION', 'Erro de conexao'), 'error');
            }
        }

        async function confirmDeleteAccount() {
            if (!confirm(t('CONFIRM_DELETE_1', 'ATENCAO: Esta acao e IRREVERSIVEL!\n\nDeseja realmente excluir sua conta?'))) return;
            if (!confirm(t('CONFIRM_DELETE_2', 'ULTIMA CONFIRMACAO: Todos os seus dados serao perdidos. Continuar?'))) return;

            try {
                const res = await fetch(`${API_BASE}/api/user`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                const msg = await getApiMessage(res, res.ok ? t('MSG_USER_DELETED', 'Conta excluida') : t('ERR_DELETE', 'Erro ao excluir conta'));
                showToast(msg, res.ok ? 'info' : 'error');
                
                if (res.ok) logout();
            } catch (err) {
                showToast(t('ERR_CONNECTION', 'Erro de conexao'), 'error');
            }
        }

        // ===========================================
        // DENUNCIAS
        // ===========================================
        function openReportModal(targetId, type) {
            document.getElementById('report-target-id').value = targetId;
            document.getElementById('report-type').value = type;
            openModal('report-modal');
        }

        async function submitReport(e) {
            e.preventDefault();
            const targetId = parseInt(document.getElementById('report-target-id').value);
            const type = parseInt(document.getElementById('report-type').value);
            const category = parseInt(document.getElementById('report-category').value);
            const reason = document.getElementById('report-reason').value.trim();

            try {
                const res = await fetch(`${API_BASE}/api/reports`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ target_id: targetId, type, category, reason })
                });

                if (res.status === 401) return handleUnauthorized();

                const msg = await getApiMessage(res, res.ok ? t('MSG_REPORT_CREATED', 'Denuncia enviada!') : t('ERR_REPORT', 'Erro ao enviar denuncia'));
                
                if (res.ok) {
                    closeModal('report-modal');
                    document.getElementById('report-reason').value = '';
                }
                showToast(msg, res.ok ? 'success' : 'error');
            } catch (err) {
                showToast(t('ERR_CONNECTION', 'Erro de conexao'), 'error');
            }
        }

        // ===========================================
        // LOCALIDADES
        // ===========================================
        async function loadLocations() {
            try {
                const res = await fetch(`${API_BASE}/api/locations`);
                locations = await res.json();
                populateStateSelects();
            } catch (err) {
                console.error('Erro ao carregar localidades:', err);
            }
        }

        function populateStateSelects() {
            const selects = ['signup-state', 'community-state'];
            const states = Object.keys(locations).sort();

            selects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    states.forEach(state => {
                        const option = document.createElement('option');
                        option.value = state;
                        option.textContent = state;
                        select.appendChild(option);
                    });
                }
            });
        }

        function loadCities() {
            const state = document.getElementById('signup-state').value;
            const citySelect = document.getElementById('signup-city');
            citySelect.innerHTML = `<option value="">${t('UI_SELECT_DEFAULT', 'Selecione...')}</option>`;

            if (state && locations[state]) {
                locations[state].forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });
            }
        }

        function loadCommunityCities() {
            const state = document.getElementById('community-state').value;
            const citySelect = document.getElementById('community-city');
            citySelect.innerHTML = '<option value="">Opcional...</option>';

            if (state && locations[state]) {
                locations[state].forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });
            }
        }

        // ===========================================
        // UTILIDADES
        // ===========================================
        function openModal(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const borderColor = type === 'success' ? 'border-neon-green' : type === 'error' ? 'border-red-500' : 'border-neon-cyan';
            const iconMap = {
                success: '[OK]',
                error: '[ERR]',
                info: '[INFO]'
            };
            
            toast.className = `bg-dark-800 border ${borderColor} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 toast-enter`;
            toast.innerHTML = `
                <span class="text-xs font-bold ${type === 'success' ? 'text-neon-green' : type === 'error' ? 'text-red-400' : 'text-neon-cyan'}">${iconMap[type] || '[INFO]'}</span>
                <span class="text-sm">${escapeHtml(message)}</span>
            `;
            
            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.remove('toast-enter');
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function handleUnauthorized() {
            showToast(t('ERR_SESSION_EXPIRED', 'Sessao expirada. Faca login novamente.'), 'error');
            logout();
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // --- CORRE√á√ÉO DE NAVEGA√á√ÉO (HISTORY API) ---
        function showSection(sectionId, pushHistory = true) {
            // 1. Esconde tudo
            const sections = ['home', 'communities', 'friends', 'notifications', 'settings', 'profile', 'community-view'];
            sections.forEach(id => {
                const el = document.getElementById(id + '-section') || document.getElementById(id);
                if (el) el.classList.add('hidden');
            });

            // 2. Mostra a certa
            const target = document.getElementById(sectionId + '-section') || document.getElementById(sectionId);
            if (target) target.classList.remove('hidden');

            // 3. Atualiza Bot√µes do Menu (Est√©tica)
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if(btn.id === `nav-${sectionId}`) {
                    btn.classList.add('text-neon-cyan', 'border-neon-cyan');
                    btn.classList.remove('text-gray-400', 'border-transparent');
                } else {
                    btn.classList.remove('text-neon-cyan', 'border-neon-cyan');
                    btn.classList.add('text-gray-400', 'border-transparent');
                }
            });

            // 4. Salva no Hist√≥rico do Navegador (O Pulo do Gato)
            if (pushHistory) {
                history.pushState({ section: sectionId }, '', `#${sectionId}`);
            }
        }

        // Escuta o bot√£o "Voltar" do navegador
        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.section) {
                showSection(event.state.section, false);
            } else {
                showSection('home', false);
            }
        });

        // Escuta o bot√£o "Voltar" do navegador
        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.section) {
                showSection(event.state.section, false);
            } else {
                showSection('feed', false);
            }
        });

        // Upload Base64 COMPLETO (sem .split)
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result); 
                reader.onerror = reject;
            });
        }

        // Close modals on background click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
